<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SQL 自动化编写助手</title>
    <!-- PWA / Add to Home Screen Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SQL 助手">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/FzJmtXTd/unnamed.png">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3E%3Cpath%20fill='%234a90e2'
        d='M448%2080v48c0%2044.2-100.3%2080-224%2080S0%20172.2%200%20128V80C0%2035.8%20100.3%200%20224%200S448%2035.8%20448%2080zM393.2%20214.7c20.8-7.4%2039.9-16.9%2054.8-28.6V288c0%2044.2-100.3%2080-224%2080S0%20332.2%200%20288V186.1c14.9%2011.8%2034%2021.2%2054.8%2028.6C99.7%20230.7%20159.5%20240%20224%20240s124.3-9.3%20169.2-25.3zM448%20368v48c0%2044.2-100.3%2080-224%2080S0%20460.2%200%20416V368c0-17.5%2013-32.9%2031.5-41.2C86.2%20344.3%20152.6%20352%20224%20352s137.8-7.7%20192.5-25.2c18.5%208.3%2031.5%2023.7%2031.5%2041.2z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #f8fafb;
            --card-bg: #ffffff;
            --text-primary: #1a1f36;
            --text-secondary: #6b7280;
            --accent-color: #4a90e2;
            --accent-light: #e3f2fd;
            --accent-dark: #2c5aa0;
            --border-color: #e5e7eb;
            --header-bg: rgba(255, 255, 255, 0.95);
            --info-bg: #e1f5fe;
            --info-border: #29b6f6;
            --danger-bg: #ff6b6b;
            --danger-hover-bg: #fa5252;
            --success-bg: #51cf66;
            --warning-bg: #ffd43b;
            --gradient-from: #4a90e2;
            --gradient-to: #64b5f6;
        }
        .dark {
            --bg-color: #0f1419;
            --card-bg: #1c2128;
            --text-primary: #e1e8ed;
            --text-secondary: #8899a6;
            --accent-color: #4a90e2;
            --accent-light: #1e3a5f;
            --accent-dark: #64b5f6;
            --border-color: #2f3336;
            --header-bg: rgba(15, 20, 25, 0.95);
            --info-bg: #0d47a1;
            --info-border: #29b6f6;
            --danger-bg: #e54848;
            --danger-hover-bg: #c53030;
            --success-bg: #48bb78;
            --warning-bg: #ecc94b;
            --gradient-from: #4a90e2;
            --gradient-to: #64b5f6;
        }

        /* 强制历史记录中的SQL代码块使用小字体 */
        .relative pre code.language-sql {
            font-size: 0.75rem !important; /* text-xs 对应的字体大小 */
            line-height: 1rem !important;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Firefox 滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        /* 暗色模式下的滚动条样式 */
        .dark ::-webkit-scrollbar-track {
            background: transparent;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }

        .dark * {
            scrollbar-color: #4a5568 transparent;
        }
        
        /* 编辑消息文本框的滚动条样式 */
        .editing-textarea::-webkit-scrollbar { width: 6px; height: 6px; }
        .editing-textarea::-webkit-scrollbar-track { background: transparent; }
        .editing-textarea::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        .editing-textarea::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
        .dark .editing-textarea::-webkit-scrollbar-thumb { background: #4a5568; }
        .dark .editing-textarea::-webkit-scrollbar-thumb:hover { background: #5a6578; }

        /* 移动端滚动条优化 */
        @media (max-width: 768px) {
            ::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }
            
            * {
                scrollbar-width: thin;
            }
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            overscroll-behavior: none;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, var(--accent-color), transparent 70%);
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }
        .ios-header {
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .ios-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        .app-mounted .ios-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--gradient-from), var(--gradient-to));
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1;
        }
        .ios-card:hover::before {
            opacity: 1;
        }
        .ios-button {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app-mounted .ios-button {
            transition: all 0.2s;
        }
        .ios-button:hover {
            background: linear-gradient(135deg, var(--accent-dark), var(--accent-color));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        .dark .ios-button:hover { 
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }
        .ios-button:active {
            transform: scale(0.98);
        }
        .ios-button:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
            box-shadow: none;
        }
        .ios-button-secondary {
            background: var(--card-bg);
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            box-shadow: none;
        }
        .dark .ios-button-secondary { 
            background-color: var(--card-bg); 
            color: var(--accent-color); 
            border-color: var(--accent-color); 
        }
        .ios-button-secondary:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }
        .ios-button-secondary:active {
            transform: scale(0.98);
        }
        .ios-button-secondary:disabled {
            background-color: var(--card-bg);
            color: #9ca3af;
            border-color: #e5e7eb;
            opacity: 0.5;
        }
        .dark .ios-button-secondary:disabled { 
            color: #4b5563; 
            border-color: #374151; 
            background-color: var(--card-bg);
        }
        .ios-button.danger {
            background: linear-gradient(135deg, var(--danger-bg), var(--danger-hover-bg));
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }
        .ios-button.danger:hover {
            background: linear-gradient(135deg, var(--danger-hover-bg), var(--danger-bg));
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        .loader {
            border: 3px solid var(--accent-light);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .small-loader {
            display: inline-block;
            border: 2px solid var(--accent-light);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        .mono { 
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; 
        }
        .copy-code-button {
            font-family: 'Inter', sans-serif;
        }
        .markdown-content {
            line-height: 1.6;
            font-size: 14px;
        }

        /* Enhanced list styles */
        .markdown-content ul li {
            position: relative;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        .markdown-content ul li::before {
            content: '•';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--text-primary);
            font-weight: bold;
            font-size: 1.2em;
        }
        .markdown-content ol li {
            position: relative;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        .markdown-content ol {
            counter-reset: list-counter;
        }
        .markdown-content ol li {
            counter-increment: list-counter;
        }
        .markdown-content ol li::before {
            content: counter(list-counter) '.';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9em;
        }

        /* Enhanced headings */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, 
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }
        .markdown-content h1 { font-size: 1.5rem; border-bottom: 2px solid var(--accent-color); padding-bottom: 0.5rem; }
        .markdown-content h2 { font-size: 1.3rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.25rem; }
        .markdown-content h3 { font-size: 1.1rem; color: var(--accent-color); }

        /* Enhanced blockquotes */
        .markdown-content blockquote {
            margin: 1rem 0;
            padding: 1rem 1.25rem;
            border-left: 4px solid var(--accent-color);
            background: var(--accent-light);
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }
        .dark .markdown-content blockquote {
            background: rgba(74, 144, 226, 0.1);
        }

        /* Enhanced horizontal rules */
        .markdown-content hr {
            margin: 2rem 0;
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
        }

        .markdown-content pre {
            position: relative;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            color: #e2e8f0;
            padding: 1rem;
            padding-top: 3rem;
            border-radius: 12px;
            overflow-x: auto;
            font-size: 0.875em;
            line-height: 1.5;
            border: 1px solid rgba(74, 144, 226, 0.2);
        }
        .dark .markdown-content pre { 
            background: linear-gradient(135deg, #1a1f36, #0f1419); 
            color: #e1e8ed; 
        }
        .markdown-content code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        .markdown-content :not(pre) > code {
            background: var(--accent-light);
            color: var(--accent-dark);
            padding: 0.1em 0.3em;
            border-radius: 6px;
            font-weight: 500;
        }
        .dark .markdown-content :not(pre) > code { 
            background: var(--accent-light); 
            color: var(--accent-color);
        }
        .markdown-content ul, .markdown-content ol {
            padding-left: 0;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            list-style: none;
        }
        .markdown-content li {
            margin-top: 0.25rem;
        }
        .markdown-content p {
            margin-bottom: 1rem;
        }
        .markdown-content > :last-child {
            margin-bottom: 0;
        }
        /* Markdown Table Styles */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .markdown-content th, .markdown-content td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .markdown-content th {
            background-color: var(--accent-light);
            font-weight: 600;
        }
        .dark .markdown-content th {
             background-color: #2f3336;
        }
        .markdown-content tr:last-child td {
            border-bottom: none;
        }
        .markdown-content tr:nth-of-type(even) {
            background-color: rgba(248, 250, 251, 0.5);
        }
        .dark .markdown-content tr:nth-of-type(even) {
            background-color: rgba(47, 51, 54, 0.3);
        }
        .dark textarea, .dark select, .dark input { 
            background-color: #1c2128; 
            border-color: #374151; 
            color: var(--text-primary); 
        }
        .dark ::placeholder { color: #6b7280; }
        .dark .bg-gray-100 { background-color: #1c2128; }
        .dark .bg-gray-200 { background-color: #2f3336; }
        .dark .bg-gray-800 { background: linear-gradient(135deg, #1a1f36, #0f1419); }
        .dark .text-gray-500 { color: var(--text-secondary); }
        .dark .text-gray-600 { color: #aac0d0; } /* Made brighter for better readability */
        .dark .text-gray-700 { color: #d1d5db; }
        .dark .text-gray-800 { color: var(--text-primary); }
        .dark .hover\:bg-gray-200:hover { background-color: #2f3336; }
        .dark .border-t { border-color: var(--border-color); }
        .dark .bg-white { background-color: var(--card-bg); }
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
            animation: toast-fade-in 0.3s ease-out, toast-fade-out 0.3s ease-in 2.7s;
            font-weight: 500;
        }
        .dark .toast-container { 
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark)); 
            color: white; 
        }
        @keyframes toast-fade-in {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes toast-fade-out {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }
        /* Message bubbles enhancement */
        .user-message {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }
        .dark .user-message {
            background: linear-gradient(135deg, #2c5aa0, #1e3a5f);
            box-shadow: 0 2px 8px rgba(44, 90, 160, 0.2);
        }
        .assistant-message {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 18px 18px 18px 4px;
            border: 1px solid var(--border-color);
        }
        .dark .assistant-message {
            background: linear-gradient(135deg, #2f3336, #1c2128);
        }
        /* Input area enhancement */
        .input-textarea {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        .app-mounted .input-textarea {
            transition: all 0.3s;
        }
        .input-textarea::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        .input-textarea:focus {
            border-color: var(--text-secondary);
            box-shadow: 0 0 0 4px rgba(107, 114, 128, 0.1);
            outline: none;
        }
        /* Decorative elements */
        .decoration-dots {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, var(--accent-light) 2px, transparent 2px);
            background-size: 10px 10px;
            opacity: 0.3;
        }
        .app-mounted .slide-panel {
             transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Button hover effects */
        .icon-button {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        .app-mounted .icon-button {
            transition: all 0.3s;
        }
        .app-mounted .icon-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(74, 144, 226, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .icon-button:hover::before {
            width: 100%;
            height: 100%;
        }
        .icon-button:active {
            transform: scale(0.95);
        }
        /* Panel close button fix */
        header .icon-button[aria-label^="关闭"] {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        /* Collapsible "Thinking Process" styles */
        .summary-text {
            color: var(--text-secondary);
        }
        .app-mounted .summary-text {
            transition: color 0.2s;
        }
        button:hover .summary-text {
            color: var(--accent-color);
        }
        .details-arrow {
            display: inline-block;
            width: 0; 
            height: 0; 
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 6px solid currentColor;
            margin-right: 8px;
            color: var(--text-secondary);
        }
        .app-mounted .details-arrow {
            transition: transform 0.3s ease-in-out;
        }
        button:hover .details-arrow {
            color: var(--accent-color);
        }
        .details-arrow.expanded {
            transform: rotate(90deg);
        }

        /* 思维过程动画容器 */
        .thinking-process-container {
            max-height: 0;
            overflow: hidden;
        }
        .app-mounted .thinking-process-container {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .thinking-process-container.expanded {
            max-height: 2000px; /* 足够大的值来容纳内容 */
        }

        .thinking-process-content {
            position: relative;
            padding-left: 1.25rem;
        }
        .thinking-process-content::before {
            content: '';
            position: absolute;
            left: 4px;
            top: 0.75rem;
            bottom: 0.75rem;
            width: 3px;
            background: linear-gradient(to bottom, var(--gradient-from), var(--gradient-to));
            border-radius: 999px;
        }
        /* SQL 预览动画容器 */
        .sql-preview-container {
            max-height: 0;
            overflow: hidden;
        }
        .app-mounted .sql-preview-container {
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sql-preview-container.expanded {
            max-height: 1000px; /* 足够大的值来容纳SQL代码 */
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            .ios-header {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            /* Show header title on mobile with smaller font */
            .ios-header .header-title {
                flex-direction: column;
                align-items: center;
                line-height: 1.2;
                gap: 0;
            }
            .ios-header .header-title h1 {
                font-size: 0.8rem;
            }
            .ios-header .header-title span:not(.w-2) {
                font-size: 0.7rem;
            }
            .ios-header .header-title .w-2.h-2 {
                display: none;
            }
            .ios-header .flex-1 {
                flex: 1 1 0%;
            }
            .input-area-buttons-container {
                flex-direction: column;
                gap: 0.5rem; /* 8px */
            }
            /* Make all buttons in input area same height */
            .input-area-buttons-container .ios-button,
            .input-area-buttons-container .ios-button-secondary {
                width: 36px;
                height: 36px;
                padding: 0;
            }
            .slide-panel {
                max-width: 100%;
            }
            main.p-4 {
                padding: 0.75rem; /* 12px */
            }
            /* Align textarea height with stacked buttons */
            #user-query {
                min-height: 80px; /* 36px*2 + 8px gap */
            }
            /* Make textarea placeholder and text smaller */
            .input-textarea {
                font-size: 0.875rem; /* 14px */
            }
            /* Make code blocks wrap on mobile */
            .markdown-content pre {
                white-space: pre-wrap;
                word-break: break-all;
            }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
  }
}
</script>
</head>
<body class="antialiased">
    <div id="root"></div>
    <script type="module">
        import React, { useState, useCallback, useMemo, useEffect, useLayoutEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        // All application code is consolidated below.
        // The original file structure has been flattened into this single script.

        // --- From types.ts ---
        // Interfaces are defined for TypeScript context but are not directly used in the compiled JS.

        // --- From constants.ts ---
        const LOCAL_STORAGE_PROFILES_KEY = 'sql_assistant_profiles_v2';
        const LOCAL_STORAGE_ACTIVE_PROFILE_ID_KEY = 'sql_assistant_active_profile_id_v2';
        const LOCAL_STORAGE_HISTORY_KEY = 'sql_assistant_history_v2';
        const LOCAL_STORAGE_THEME_KEY = 'sql_assistant_theme_v1';
        const LOCAL_STORAGE_ACTIVE_CONVERSATION_KEY = 'sql_assistant_active_conversation_v2';
        const LOCAL_STORAGE_ACTIVE_HISTORY_ID_KEY = 'sql_assistant_active_history_id_v2';

        const DEFAULT_SETTINGS = {
            apiUrl: 'https://generativelanguage.googleapis.com/v1beta',
            apiKey: '',
            apiModel: 'gemini-2.5-flash',
            maxHistory: 10,
            guidePrompt: `规则:
- 使用标准SQL语法
- 添加必要的注释
- 考虑查询性能`,
            dbSchema: `tables:
  employees:
    - id: int
    - name: varchar
    - department: varchar`,
            exampleChat: `- 用户: 查询所有员工
  SQL: SELECT * FROM employees
- 用户: 统计各部门人数
  SQL: SELECT department, COUNT(*) FROM employees GROUP BY department`,
            terminology: `术语:
  KPI: 关键绩效指标
  YoY: 同比增长
  活跃用户: 最近30天内有登录行为的用户`,
        };

        const DEFAULT_PROFILE = {
            id: 'default_profile_1',
            name: '默认配置 (Gemini)',
            settings: DEFAULT_SETTINGS,
        };

        // --- From utils/fileUtils.ts ---
        const downloadAsJson = (data, filename) => {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const readJsonFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const result = event.target?.result;
                        if (typeof result === 'string') {
                            resolve(JSON.parse(result));
                        } else {
                            reject(new Error('File content is not a string.'));
                        }
                    } catch (error) {
                        reject(new Error('Failed to parse JSON file.'));
                    }
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsText(file);
            });
        };

        const readExcelFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const result = event.target?.result;
                        if (result instanceof ArrayBuffer) {
                            const workbook = XLSX.read(result, {
                                cellStyles: true,
                                cellFormulas: true,
                                cellDates: true,
                                cellNF: true,
                                sheetStubs: true
                            });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            let textContent = '';
                            jsonData.forEach((row, index) => {
                                if (row.length > 0) {
                                    textContent += `第${index + 1}行: ${row.filter(cell => cell !== undefined && cell !== null && cell !== '').join(' | ')}\n`;
                                }
                            });
                            
                            resolve(textContent);
                        } else {
                            reject(new Error('文件读取失败'));
                        }
                    } catch (error) {
                        reject(new Error('Excel文件解析失败'));
                    }
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsArrayBuffer(file);
            });
        };

        // --- From services/apiService.ts ---
        const BUILT_IN_PROMPTS = {
            'guidePrompt': '以下是用户提供的自定义SQL生成规则和要求，请严格遵守：',
            'dbSchema': '以下是数据库的表结构定义，包含所有可用的表名和字段名：',
            'exampleChat': '以下是一些示例对话，展示了期望的查询模式和SQL生成风格：',
            'terminology': '以下是业务相关的专业术语定义，请在理解用户需求时参考：'
        };

        const generateSimpleText = async (settings, prompt, signal) => {
            let requestUrl;
            let requestOptions;
            const isGemini = settings.apiUrl.includes('googleapis.com');

            try {
                if (isGemini) {
                    requestUrl = `${settings.apiUrl}/models/${settings.apiModel}:generateContent?key=${settings.apiKey}`;
                    const body = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.1, topP: 0.95 }
                    };
                    requestOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                        signal
                    };
                } else {
                    if (settings.apiUrl.includes('/chat/completions')) {
                        requestUrl = settings.apiUrl;
                    } else {
                        const baseUrl = settings.apiUrl.endsWith('/') ? settings.apiUrl : settings.apiUrl + '/';
                        requestUrl = new URL('chat/completions', baseUrl).href;
                    }

                    const messages = [{ role: 'user', content: prompt }];
                    requestOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${settings.apiKey}`
                        },
                        body: JSON.stringify({
                            model: settings.apiModel,
                            messages: messages,
                            temperature: 0.1,
                            stream: false
                        }),
                        signal
                    };
                }

                console.info('API Call (Simple Text) Started:', { url: requestUrl, method: 'POST' });
                console.log('Prompt:', prompt);

                const response = await fetch(requestUrl, requestOptions);

                if (!response.ok) {
                    let errData;
                    try {
                        errData = await response.json();
                    } catch (e) {
                        errData = { error: { message: await response.text() } };
                    }
                    let errMsg = errData.error?.message || `HTTP error! status: ${response.status}`;
                    throw new Error(errMsg);
                }

                const data = await response.json();
                
                let resultText;
                if (isGemini) {
                    resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                } else {
                    resultText = data.choices?.[0]?.message?.content || '';
                }
                
                console.log('API Call (Simple Text) Succeeded. Response:', resultText);
                return resultText;

            } catch (error) {
                console.error('API Call (Simple Text) Failed:', error instanceof Error ? error.message : String(error));
                if (error instanceof Error) {
                    throw error;
                }
                throw new Error(String(error));
            }
        };

        const generateSqlStream = async (chatHistory, settings, signal, onChunk, onComplete, onError) => {
            let requestUrl;
            let requestOptions;
            const isGemini = settings.apiUrl.includes('googleapis.com');

            try {
                let systemPromptBase;

                let customPrompts = "";
                (Object.keys(BUILT_IN_PROMPTS)).forEach(key => {
                    const content = settings[key]?.trim();
                    if (content) {
                        const title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        customPrompts += `\n\n--- ${title} ---\n`;
                        customPrompts += `${BUILT_IN_PROMPTS[key]}\n${content}`;
                    }
                });

                if (isGemini) {
                    systemPromptBase = "You are a professional SQL writing assistant. Please generate or refine SQL based on the user's request, considering the entire conversation history. Use the following information as your guide.\n\nFirst, provide a brief thinking process, which may include other code blocks. After that, provide the final, complete SQL code inside a markdown code block.";
                    
                    const systemPrompt = systemPromptBase + customPrompts;

                    requestUrl = `${settings.apiUrl}/models/${settings.apiModel}:streamGenerateContent?alt=sse&key=${settings.apiKey}`;
                    
                    const contents = chatHistory
                        .filter(msg => (msg.content && msg.content.trim() !== '') || msg.image)
                        .map(msg => {
                            const parts = [];
                            if (msg.image) {
                                parts.push({
                                    inlineData: {
                                        mimeType: msg.image.mimeType,
                                        data: msg.image.data
                                    }
                                });
                            }
                            if (msg.content && msg.content.trim() !== '') {
                                parts.push({ text: msg.content });
                            }
                            return {
                                role: msg.role === 'assistant' ? 'model' : 'user',
                                parts
                            };
                        });

                    const body = {
                        contents,
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { temperature: 0.2, topP: 0.95 }
                    };
                    
                    requestOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                        signal
                    };
                } else {
                    systemPromptBase = "You are a professional SQL writing assistant. Please generate or refine SQL based on the user's request, considering the entire conversation history. Use the following information as your guide.\n\nFirst, provide a brief thinking process, which may include other code blocks. After that, provide the final, complete SQL code inside a markdown code block.";
                    
                    const systemPrompt = systemPromptBase + customPrompts;
                    
                    if (settings.apiUrl.includes('/chat/completions')) {
                        requestUrl = settings.apiUrl;
                    } else {
                        const baseUrl = settings.apiUrl.endsWith('/') ? settings.apiUrl : settings.apiUrl + '/';
                        requestUrl = new URL('chat/completions', baseUrl).href;
                    }

                    const openAICompatibleMessages = chatHistory.map(msg => {
                        if (msg.image && msg.role === 'user') {
                            const contentParts = [];
                            if (msg.content && msg.content.trim()) {
                                contentParts.push({ type: 'text', text: msg.content });
                            }
                            contentParts.push({
                                type: 'image_url',
                                image_url: {
                                    url: `data:${msg.image.mimeType};base64,${msg.image.data}`
                                }
                            });
                            return { role: 'user', content: contentParts };
                        }
                        return { role: msg.role, content: msg.content };
                    });

                    const messages = [{ role: 'system', content: systemPrompt }, ...openAICompatibleMessages];
                    
                    requestOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${settings.apiKey}`
                        },
                        body: JSON.stringify({
                            model: settings.apiModel,
                            messages: messages,
                            temperature: 0.1,
                            stream: true
                        }),
                        signal
                    };
                }
                
                console.info('API Call (Stream) Started:', {
                    url: requestUrl,
                    method: 'POST',
                    model: settings.apiModel,
                    historyLength: chatHistory.length
                });

                const response = await fetch(requestUrl, requestOptions);

                if (!response.ok) {
                    const hasImage = chatHistory.some(msg => msg.image);
                    if (hasImage && response.status >= 400 && response.status < 500) {
                         throw new Error('当前配置的API不支持图片上传功能，或图片格式/大小有误。');
                    }
                    
                    let errData;
                    try {
                      errData = await response.json();
                    } catch(e) {
                      errData = { error: { message: await response.text() }};
                    }

                    let errMsg = errData.error?.message || `HTTP error! status: ${response.status}`;
                    if (response.status === 401) errMsg += '\n\n可能是API Key无效或已过期，请检查您的API Key。';
                    if (response.status === 429) errMsg += '\n\nAPI请求频率超限，请稍后再试。';
                    if (isGemini && response.status === 400) errMsg += '\n\n请求格式错误，请检查API URL和模型名称是否适用于Gemini。';
                    throw new Error(errMsg);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponseText = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            if (!isGemini && jsonStr === '[DONE]') {
                                console.log('API Call (Stream) Completed Successfully. Full Response:', fullResponseText);
                                onComplete();
                                return;
                            }
                            try {
                                const chunk = JSON.parse(jsonStr);
                                let content = '';
                                if (isGemini) {
                                    content = chunk.candidates?.[0]?.content?.parts?.[0]?.text;
                                } else {
                                    content = chunk.choices?.[0]?.delta?.content;
                                }
                                if (content) {
                                    fullResponseText += content;
                                    onChunk(content);
                                }
                            } catch (e) {
                                // Ignore JSON parsing errors for incomplete chunks
                            }
                        }
                    }
                }
                console.log('API Call (Stream) Completed Successfully. Full Response:', fullResponseText);
                onComplete();
            } catch (error) {
                 console.error('API Call (Stream) Failed:', error instanceof Error ? error.message : String(error), error);
                 if (error instanceof Error) {
                    onError(error);
                } else {
                    onError(new Error(String(error)));
                }
            }
        };

        const fetchModels = async (apiUrl, apiKey) => {
            let modelsUrl;
            let requestOptions;
            try {
                if (!apiUrl.trim() || !apiKey.trim()) {
                    throw new Error('API URL and Key cannot be empty.');
                }

                const isGemini = apiUrl.includes('googleapis.com');
                
                if (isGemini) {
                    modelsUrl = `${apiUrl}/models?key=${apiKey}`;
                    requestOptions = { method: 'GET' };
                } else {
                    if (!/^https?:\/\//.test(apiUrl)) {
                        throw new Error('API URL must start with http:// or https://');
                    }
                    if (apiUrl.includes('/chat/completions')) {
                        modelsUrl = apiUrl.replace('/chat/completions', '/models');
                    } else {
                        modelsUrl = new URL('/v1/models', apiUrl).href;
                    }
                    requestOptions = {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    };
                }
                
                console.info('API Call (Fetch Models) Started:', { url: modelsUrl, method: 'GET' });

                const response = await fetch(modelsUrl, requestOptions);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let models = [];

                if (isGemini) {
                    if (data.models && Array.isArray(data.models)) {
                        models = data.models.map(m => m.name.replace('models/', '')).filter(Boolean).sort();
                    }
                } else {
                    if (data.data && Array.isArray(data.data)) {
                        models = data.data.map((m) => m.id).filter(Boolean).sort();
                    }
                }

                if (models.length > 0) {
                    console.log('API Call (Fetch Models) Succeeded. Models found:', models);
                    return models;
                }
                
                throw new Error('Invalid response format or no models found from endpoint.');
            } catch (error) {
                console.error('API Call (Fetch Models) Failed:', error instanceof Error ? error.message : String(error));
                throw error;
            }
        };


        // --- From hooks/useLocalStorage.ts ---
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                if (typeof window === 'undefined') {
                    return initialValue;
                }
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            useEffect(() => {
                try {
                    if (typeof window !== 'undefined') {
                        window.localStorage.setItem(key, JSON.stringify(storedValue));
                    }
                } catch (error) {
                    console.error(error);
                }
            }, [key, storedValue]);

            return [storedValue, setStoredValue];
        }
        
        // --- From components/icons.tsx ---
        const HistoryIcon = () => (
            React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('path', { d: 'M3 3v5h5' }),
                React.createElement('path', { d: 'M3.05 13A9 9 0 1 0 8 3.46' }),
                React.createElement('path', { d: 'M12 7v5l4 2' })
            )
        );

        const SettingsIcon = () => (
            React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('circle', { cx: '12', cy: '12', r: '3' }),
                React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z' })
            )
        );
        
        const SunIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}, React.createElement('circle',{cx:"12",cy:"12",r:"5"}), React.createElement('line',{x1:"12",y1:"1",x2:"12",y2:"3"}), React.createElement('line',{x1:"12",y1:"21",x2:"12",y2:"23"}), React.createElement('line',{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}), React.createElement('line',{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}), React.createElement('line',{x1:"1",y1:"12",x2:"3",y2:"12"}), React.createElement('line',{x1:"21",y1:"12",x2:"23",y2:"12"}), React.createElement('line',{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}), React.createElement('line',{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"}));
        const MoonIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}, React.createElement('path',{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"}));
        const InfoIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('circle',{cx:"12",cy:"12",r:"10"}), React.createElement('line',{x1:"12",y1:"16",x2:"12",y2:"12"}), React.createElement('line',{x1:"12",y1:"8",x2:"12.01",y2:"8"}));
        const ConsoleIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}, React.createElement('polyline', {points: "4 17 10 11 4 5"}), React.createElement('line', {x1: "12", y1: "19", x2: "20", y2: "19"}));
        const SendIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: "h-5 w-5"}, React.createElement('line', { x1: "22", y1: "2", x2: "11", y2: "13" }), React.createElement('polygon', { points: "22 2 15 22 11 13 2 9 22 2" }));
        const StopIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "currentColor", className: "h-5 w-5 text-white" }, React.createElement('rect', { x: "6", y: "6", width: "12", height: "12", rx: "1" }));
        const EditIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('path', { d: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"}));
        const RegenerateIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: "h-5 w-5"}, React.createElement('path', { d: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" }), React.createElement('path', { d: "M21 3v5h-5" }), React.createElement('path', { d: "M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" }), React.createElement('path', { d: "M3 21v-5h5" }));
        const PlusIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}, React.createElement('line',{x1:"12",y1:"5",x2:"12",y2:"19"}), React.createElement('line',{x1:"5",y1:"12",x2:"19",y2:"12"}));

        // --- From components/Toast.tsx ---
        const Toast = ({ message }) => {
            return React.createElement('div', { className: 'toast-container' }, message);
        };

        // --- From components/Header.tsx ---
        const Header = ({ onHistoryClick, onSettingsClick, onTutorialClick, onToggleTheme, onConsoleClick, onNewChat, theme, activeProfileName }) => {
            return (
                React.createElement('header', { className: 'ios-header sticky top-0 z-30 px-4 py-3 flex-shrink-0' },
                    React.createElement('div', { className: 'max-w-7xl mx-auto flex justify-between items-center' },
                        React.createElement('div', { className: 'flex-1 flex justify-start items-center gap-1' },
                            React.createElement('button', { onClick: onHistoryClick, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '查看历史' },
                                React.createElement(HistoryIcon, null)
                            ),
                            React.createElement('button', { onClick: onConsoleClick, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '查看控制台' },
                                React.createElement(ConsoleIcon, null)
                            ),
                             React.createElement('button', { onClick: onNewChat, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors ml-[-4px]', 'aria-label': '开启新对话' },
                                React.createElement(PlusIcon, null)
                            )
                        ),
                        React.createElement('div', { className: 'header-title flex items-center gap-2' },
                            React.createElement('h1', { className: 'text-xl font-bold bg-gradient-to-r from-[var(--gradient-from)] to-[var(--gradient-to)] bg-clip-text text-transparent' }, 'SQL 自动化编写助手'),
                            React.createElement('span', { className: 'w-2 h-2 bg-gradient-to-r from-[var(--gradient-from)] to-[var(--gradient-to)] rounded-full' }),
                            React.createElement('span', { className: 'text-xl font-semibold text-gray-600 dark:text-gray-400' }, activeProfileName)
                        ),
                        React.createElement('div', { className: 'flex-1 flex justify-end items-center gap-1' },
                           React.createElement('button', { onClick: onToggleTheme, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '切换主题' },
                                theme === 'light' ? React.createElement(MoonIcon, null) : React.createElement(SunIcon, null)
                            ),
                            React.createElement('button', { onClick: onTutorialClick, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '查看教程' },
                                React.createElement(InfoIcon, null)
                            ),
                            React.createElement('button', { onClick: onSettingsClick, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '打开设置' },
                                React.createElement(SettingsIcon, null)
                            )
                        )
                    )
                )
            );
        };
        
        // --- From components/MarkdownRenderer.tsx ---
        const MarkdownRenderer = ({ markdown }) => {
            const contentRef = useRef(null);

            useEffect(() => {
                if (!contentRef.current || !window.marked) return;

                const rawHtml = window.marked.parse(markdown || '');
                contentRef.current.innerHTML = rawHtml;
                
                const preBlocks = contentRef.current.querySelectorAll('pre');
                
                preBlocks.forEach(pre => {
                    if (pre.querySelector('.copy-code-button')) return;

                    pre.style.position = 'relative';
                    pre.style.paddingTop = '3rem';

                    // 添加语法高亮
                    const codeElement = pre.querySelector('code');
                    if (codeElement && window.Prism) {
                        // 检测是否是SQL代码块
                        const codeText = codeElement.textContent || '';
                        const sqlKeywords = ['SELECT', 'FROM', 'WHERE', 'INSERT', 'UPDATE', 'DELETE', 'JOIN', 'GROUP BY', 'ORDER BY'];
                        const isSqlCode = sqlKeywords.some(keyword => 
                            codeText.toUpperCase().includes(keyword)
                        );
                        
                        if (isSqlCode) {
                            codeElement.className = 'language-sql';
                        } else {
                            codeElement.className = 'language-sql'; // 默认使用SQL高亮
                        }
                        
                        // 应用语法高亮
                        window.Prism.highlightElement(codeElement);
                    }

                    const copyButton = document.createElement('button');
                    const copyText = '复制';
                    const copiedText = '已复制!';
                    copyButton.innerHTML = `<i class="fa-regular fa-clipboard mr-1"></i> ${copyText}`;
                    copyButton.className = 'copy-code-button ios-button ios-button-secondary text-sm font-semibold py-1 px-3 absolute top-2 right-2 z-10';

                    copyButton.onclick = () => {
                        const code = pre.querySelector('code');
                        if (code) {
                            navigator.clipboard.writeText(code.innerText).then(() => {
                                copyButton.innerHTML = `<i class="fa-solid fa-check mr-1"></i> ${copiedText}`;
                                setTimeout(() => {
                                    copyButton.innerHTML = `<i class="fa-regular fa-clipboard mr-1"></i> ${copyText}`;
                                }, 2000);
                            }).catch(err => {
                                copyButton.innerText = '复制失败!';
                                console.error('Failed to copy code: ', err);
                            });
                        }
                    };
                    pre.appendChild(copyButton);
                });

            }, [markdown]);

            return React.createElement('div', {
                ref: contentRef,
                className: 'markdown-content'
            });
        };
        
        // --- From components/AssistantMessageRenderer.tsx ---
        const CollapsibleSection = ({ title, children }) => {
            const [isExpanded, setIsExpanded] = React.useState(false);
            return React.createElement('div', { className: 'mb-3' },
                React.createElement('button', { 
                    className: 'text-sm font-medium flex items-center w-full text-left',
                    onClick: () => setIsExpanded(!isExpanded)
                },
                    React.createElement('span', { 
                        className: `details-arrow ${isExpanded ? 'expanded' : ''}` 
                    }),
                    React.createElement('span', { className: 'summary-text' }, title)
                ),
                React.createElement('div', { 
                    className: `thinking-process-container ${isExpanded ? 'expanded' : ''}` 
                },
                    React.createElement('div', { className: 'thinking-process-content pt-3 mt-2 border-t border-dashed border-[var(--border-color)]' },
                        children
                    )
                )
            );
        };

        const AssistantMessageRenderer = ({ markdown }) => {
            const { thinkingProcess, finalAnswer } = useMemo(() => {
                const fullMarkdown = markdown || '';
                const codeBlockRegex = /```(?:[a-zA-Z]*)?\n[\s\S]*?\n```/g;
                const matches = [...fullMarkdown.matchAll(codeBlockRegex)];

                if (matches.length <= 1) {
                    return { thinkingProcess: null, finalAnswer: fullMarkdown };
                }

                const lastMatch = matches[matches.length - 1];
                const lastIndex = lastMatch.index;

                const thinkingPart = fullMarkdown.substring(0, lastIndex).trim();
                const finalPart = fullMarkdown.substring(lastIndex).trim();

                if (!thinkingPart) {
                    return { thinkingProcess: null, finalAnswer: fullMarkdown };
                }

                return { thinkingProcess: thinkingPart, finalAnswer: finalPart };
            }, [markdown]);

            return React.createElement(React.Fragment, null,
                thinkingProcess && React.createElement(CollapsibleSection, { title: '查看思考过程' },
                    React.createElement(MarkdownRenderer, { markdown: thinkingProcess })
                ),
                React.createElement(MarkdownRenderer, { markdown: finalAnswer })
            );
        };

        // --- From components/MainContent.tsx ---
        const MainContent = ({ conversation, isLoading, editingIndex, editedContent, editedImage, setEditedContent, setEditedImage, onSaveEdit, onCancelEdit, onStartEdit, onSuggestionClick, isMounted, onRemoveEditedImage, onPreviewImage }) => {
            const chatContainerRef = useRef(null);
            const prevEditingIndex = useRef(null);
            const messageRefs = useRef(new Map());
            const editImageInputRef = useRef(null);

            useLayoutEffect(() => {
                const chatContainer = chatContainerRef.current;
                if (!chatContainer) return;

                if (prevEditingIndex.current === null && editingIndex !== null) {
                    const messageElement = messageRefs.current.get(editingIndex);
                    if (messageElement) {
                        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                else if (prevEditingIndex.current !== null && editingIndex === null) {
                }
                else if (editingIndex === null) {
                    setTimeout(() => {
                        if (chatContainer?.lastElementChild) {
                            chatContainer.lastElementChild.scrollIntoView({ behavior: 'auto', block: 'end' });
                        }
                    }, 0);
                }

                prevEditingIndex.current = editingIndex;

            }, [conversation, editingIndex, isMounted]);

            const startEditing = (index, content, image) => {
                onStartEdit(index, content, image);
            };

            const processEditImageFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    const base64Data = dataUrl.split(',')[1];
                    setEditedImage({
                        data: base64Data,
                        mimeType: file.type,
                        dataUrl: dataUrl
                    });
                };
                reader.readAsDataURL(file);
            };

            const handleEditImageUpload = (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    processEditImageFile(file);
                }
                event.target.value = ''; // Allow re-uploading the same file
            };

            const handleEditPaste = (event) => {
                const items = (event.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            processEditImageFile(file);
                            event.preventDefault();
                            return;
                        }
                    }
                }
            };


            return React.createElement('div', { className: 'ios-card flex flex-col flex-grow min-h-0' },
                React.createElement('div', { ref: chatContainerRef, className: 'flex-grow overflow-y-auto p-5 space-y-6' },
                    conversation.length === 0 ? (
                         React.createElement('div', { className: 'text-center text-gray-500 flex flex-col h-full' },
                            React.createElement('div', { className: 'flex-grow flex flex-col justify-center items-center' },
                                React.createElement('div', { className: 'w-20 h-20 bg-gradient-to-br from-[var(--gradient-from)] to-[var(--gradient-to)] rounded-full mb-4 flex items-center justify-center shadow-lg' },
                                    React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', viewBox: '0 0 448 512', className: 'w-10 h-10 fill-white' },
                                        React.createElement('path', { d: 'M448 80v48c0 44.2-100.3 80-224 80S0 172.2 0 128V80C0 35.8 100.3 0 224 0S448 35.8 448 80zM393.2 214.7c20.8-7.4 39.9-16.9 54.8-28.6V288c0 44.2-100.3 80-224 80S0 332.2 0 288V186.1c14.9 11.8 34 21.2 54.8 28.6C99.7 230.7 159.5 240 224 240s124.3-9.3 169.2-25.3zM448 368v48c0 44.2-100.3 80-224 80S0 460.2 0 416V368c0-17.5 13-32.9 31.5-41.2C86.2 344.3 152.6 352 224 352s137.8-7.7 192.5-25.2c18.5 8.3 31.5 23.7 31.5 41.2z' })
                                    )
                                ),
                                React.createElement('h3', { className: 'text-xl font-semibold mb-2' }, 'SQL 自动化编写助手'),
                                React.createElement('p', null, '输入您的需求开始生成SQL。'),
                                React.createElement('p', null, '您可以持续对话，对生成的SQL进行修改和完善。')
                            ),
                            React.createElement('div', { className: 'w-full max-w-3xl mx-auto pb-4' },
                                React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-3 gap-3' },
                                    React.createElement('button', { onClick: () => onSuggestionClick('我要改写老数据库SQL代码'), className: 'ios-button ios-button-secondary text-sm h-auto p-3' }, '我要改写老数据库SQL代码'),
                                    React.createElement('button', { onClick: () => onSuggestionClick('我要SQL代码纠错'), className: 'ios-button ios-button-secondary text-sm h-auto p-3' }, '我要SQL代码纠错'),
                                    React.createElement('button', { onClick: () => onSuggestionClick('我要描述业务需求写新代码'), className: 'ios-button ios-button-secondary text-sm h-auto p-3' }, '我要描述业务需求写新代码')
                                )
                            )
                        )
                    ) : (
                        conversation.map((msg, index) => {
                            const refCallback = (node) => {
                                const map = messageRefs.current;
                                if (node) {
                                    map.set(index, node);
                                } else {
                                    map.delete(index);
                                }
                            };
                            if (msg.role === 'user') {
                                return React.createElement('div', {
                                    key: index,
                                    ref: refCallback,
                                    className: `flex justify-end group ${editingIndex === index ? '' : 'items-end gap-2'}`.trim()
                                },
                                editingIndex === index ?
                                    React.createElement('div', { className: 'user-message p-3 w-full max-w-[75%]' },
                                        React.createElement('input', { type: 'file', ref: editImageInputRef, className: 'hidden', accept: 'image/*', onChange: handleEditImageUpload }),
                                        editedImage && React.createElement('div', { className: 'relative mb-2 w-24 h-24' },
                                            React.createElement('img', { src: editedImage.dataUrl, alt: '正在编辑的图片', className: 'w-full h-full object-cover rounded-lg border-2 border-white/30 cursor-pointer', onClick: () => onPreviewImage(editedImage.dataUrl) }),
                                            React.createElement('button', {
                                                onClick: onRemoveEditedImage,
                                                className: 'absolute -top-2 -right-2 bg-[var(--danger-bg)] text-white w-6 h-6 rounded-full flex items-center justify-center shadow-md hover:bg-[var(--danger-hover-bg)] transition',
                                                'aria-label': '移除图片'
                                            }, React.createElement('i', { className: 'fa-solid fa-xmark' }))
                                        ),
                                        React.createElement('textarea', {
                                            value: editedContent,
                                            onChange: e => setEditedContent(e.target.value),
                                            onPaste: handleEditPaste,
                                            className: 'w-full bg-white/20 rounded-md p-2 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 editing-textarea',
                                            rows: 3
                                        }),
                                        React.createElement('div', { className: 'flex justify-end items-center gap-2 mt-2' },
                                            React.createElement('button', { onClick: () => editImageInputRef.current?.click(), className: 'h-8 text-xs px-3 py-1 rounded-lg font-semibold bg-white/20 text-white hover:bg-white/30 transition transform active:scale-95 flex items-center justify-center min-w-16' }, React.createElement('i', { className: 'fa-solid fa-image' })),
                                            React.createElement('button', { onClick: onCancelEdit, className: 'h-8 text-xs px-3 py-1 rounded-lg font-semibold bg-gray-400 text-white hover:bg-gray-500 transition transform active:scale-95 flex items-center justify-center min-w-16' }, '取消'),
                                            React.createElement('button', { onClick: onSaveEdit, className: 'h-8 text-xs px-3 py-1 rounded-lg font-semibold bg-white text-[var(--accent-color)] hover:bg-gray-100 transition transform active:scale-95 flex items-center justify-center min-w-16' }, '保存')
                                        )
                                    ) :
                                    [
                                        React.createElement('button', {
                                            key: `edit-${index}`,
                                            onClick: () => startEditing(index, msg.content, msg.image),
                                            disabled: isLoading,
                                            className: 'opacity-0 group-hover:opacity-100 transition-opacity p-1 text-gray-500 hover:text-[var(--accent-color)] disabled:opacity-20 active:scale-90 mb-1 flex-shrink-0', 'aria-label': '编辑'
                                        },
                                            React.createElement(EditIcon, null)
                                        ),
                                        React.createElement('div', {
                                            key: `msg-${index}`,
                                            className: 'user-message p-3 max-w-[75%]'
                                        },
                                            msg.image && React.createElement('img', { src: msg.image.dataUrl, alt: '用户上传的图片', className: 'mb-2 rounded-lg max-w-full h-auto border-2 border-white/30 cursor-pointer', onClick: () => onPreviewImage(msg.image.dataUrl) }),
                                            msg.content && React.createElement('div', { className: 'whitespace-pre-wrap break-words text-sm' }, msg.content)
                                        )
                                    ]
                                )
                            } else {
                                return React.createElement('div', { key: index, ref: refCallback, className: 'flex justify-start' },
                                    React.createElement('div', { className: `assistant-message p-3 w-full ${msg.isError ? 'border-l-4 border-[var(--danger-bg)]' : ''}` },
                                        React.createElement('div', { className: 'flex justify-between items-center mb-2' },
                                            React.createElement('span', { className: 'text-sm font-semibold text-[var(--accent-color)]' }, '助手')
                                        ),
                                        msg.isStreaming ?
                                            React.createElement('pre', { className: 'p-3 overflow-x-auto text-sm mono whitespace-pre-wrap' },
                                                React.createElement('code', null,
                                                    msg.content,
                                                    React.createElement('span', { className: 'inline-block w-2 h-4 bg-[var(--accent-color)] animate-pulse ml-1 align-middle' })
                                                )
                                            )
                                        :
                                            React.createElement(AssistantMessageRenderer, { markdown: msg.content })
                                    )
                                )
                            }
                        })
                    ),
                    isLoading && conversation[conversation.length - 1]?.isStreaming !== true && React.createElement('div', { className: 'flex items-center gap-3 p-4' },
                        React.createElement('div', { className: 'small-loader' }),
                        React.createElement('p', { className: 'text-gray-600 animate-pulse' }, '助手正在思考...')
                    )
                )
            );
        };
        
        // --- From components/SettingsPanel.tsx ---
        const promptFields = [
            { key: 'guidePrompt', label: '1. SQL生成规则 (Guide Prompt)', description: 'AI将理解这是您提供的自定义SQL生成规则和要求', placeholder: '输入您的自定义引导提示...\n例如：\n规则:\n - 使用标准SQL语法...' },
            { key: 'dbSchema', label: '2. 数据库表结构 (DB Schema)', description: 'AI将理解这是数据库的表名和字段名定义', placeholder: '输入表名和字段名...\n例如：\ntables:\n  employees:\n    - id: int...' },
            { key: 'exampleChat', label: '3. 示例对话 (Example Chat)', description: 'AI将参考这些示例来理解您的查询模式', placeholder: '输入示例对话...\n例如：\n- 用户: 查询所有员工\n  SQL: SELECT * FROM employees' },
            { key: 'terminology', label: '4. 行业术语定义 (Terminology)', description: 'AI将根据这些定义理解特定的业务术语', placeholder: '输入行业术语及其定义...\n例如：\n术语:\n  KPI: 关键绩效指标' },
        ];

        const SettingsPanel = ({ isOpen, onClose, activeProfile, profiles, onSave, onSwitch, onCreate, onDelete, onRename, onExport, onExportAll, onShowToast }) => {
            const [currentSettings, setCurrentSettings] = useState(activeProfile.settings);
            const [newProfileName, setNewProfileName] = useState('');
            const [optimizingState, setOptimizingState] = useState({ key: null, controller: null });
            const importFileRef = useRef(null);
            const [availableModels, setAvailableModels] = useState([]);
            const [isFetchingModels, setIsFetchingModels] = useState(false);
            const [fullscreenPrompt, setFullscreenPrompt] = useState(null);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);

            useEffect(() => {
                setCurrentSettings(activeProfile.settings);
                setAvailableModels(activeProfile.settings.apiModel ? [activeProfile.settings.apiModel] : []);
            }, [activeProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setCurrentSettings(prev => ({ ...prev, [name]: value }));
            };

            const handleSave = () => {
                const { maxHistory, ...restSettings } = currentSettings;
                const numMaxHistory = parseInt(maxHistory, 10);

                if (String(maxHistory).trim() === '' || isNaN(numMaxHistory) || numMaxHistory < 1 || numMaxHistory > 50) {
                    alert('历史会话记录最大条数必须是 1 到 50 之间的数字。');
                    return;
                }
                
                onSave({ ...restSettings, maxHistory: numMaxHistory });
            };
            
            const handleResetCurrentSettings = () => {
                if (window.confirm('确定要将当前表单中的所有配置信息重置为默认值吗？此操作不会影响已保存的配置。')) {
                    setCurrentSettings(DEFAULT_SETTINGS);
                    onShowToast('表单已重置为默认值。');
                }
            };

            const handleFileChange = async (e, key) => {
                const file = e.target.files?.[0];
                if (file) {
                    try {
                        let content;
                        const fileName = file.name.toLowerCase();

                        if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                            if (!window.XLSX) {
                                throw new Error('Excel解析库 (SheetJS) 未加载。');
                            }
                            content = await readExcelFile(file);
                        } else {
                            content = await file.text();
                        }
                        
                        setCurrentSettings(prev => ({...prev, [key]: content}));
                        onShowToast('文件内容已成功导入！');
                    } catch (error) {
                        alert(`文件处理失败: ${error instanceof Error ? error.message : String(error)}`);
                    }
                }
                e.target.value = ''; // Allow re-uploading the same file
            };
            
            const handleSaveNewProfile = () => {
                if (!newProfileName.trim()) {
                    alert('请输入新配置的名称。');
                    return;
                }
                onCreate(newProfileName.trim(), DEFAULT_SETTINGS);
                setNewProfileName('');
            };

            const handleStopOptimization = () => {
                if (optimizingState.controller) {
                    optimizingState.controller.abort();
                    console.log('Optimization stopped by user.');
                }
                setOptimizingState({ key: null, controller: null });
            };
            
            const handleOptimizePrompt = async (key, contentToOptimize, onComplete) => {
                if (!currentSettings.apiUrl || !currentSettings.apiKey) {
                    alert('请先在API配置中设置API链接和Key。');
                    return;
                }
                const originalContent = contentToOptimize ?? currentSettings[key];
                if (!originalContent.trim()) {
                    alert('内容为空，无需优化。');
                    return;
                }
                
                const controller = new AbortController();
                setOptimizingState({ key, controller });

                try {
                    const prompt = `You are an expert YAML converter. Your task is to convert the following text into a clean, well-structured YAML format. **Strictly output only the YAML content itself, wrapped within <yaml_output> tags.** Do not include any explanations, introductions, or conversational text. The text to convert is:\n\n---\n\n${originalContent}`;
                    
                    const apiResponse = await generateSimpleText(currentSettings, prompt, controller.signal);
                    const match = apiResponse.match(/<yaml_output>([\s\S]*)<\/yaml_output>/);
                    const optimizedContent = match ? match[1].trim() : apiResponse.trim();
                    
                    if (optimizedContent) {
                        onComplete(optimizedContent);
                        onShowToast(`"${promptFields.find(f => f.key === key)?.label}" 已优化！`);
                    } else {
                        throw new Error("API did not return any parsable content.");
                    }
                } catch (error) {
                     if (error.name !== 'AbortError') {
                        alert(`优化失败: ${error instanceof Error ? error.message : '未知错误'}`);
                    }
                } finally {
                    setOptimizingState(prevState => {
                        if (prevState.key === key) {
                            return { key: null, controller: null };
                        }
                        return prevState;
                    });
                }
            };

            const handleImport = async (e) => {
                const files = e.target.files;
                if (!files || files.length === 0) return;

                let importedCount = 0;
                let errors = [];

                for (const file of files) {
                    try {
                        const importedSettings = await readJsonFile(file);
                        if (typeof importedSettings === 'object' && importedSettings !== null && 'apiUrl' in importedSettings) {
                            const name = file.name.replace(/\.json$/i, '');
                            onCreate(name, importedSettings);
                            importedCount++;
                        } else {
                            errors.push(`${file.name}: 文件内容不是有效的配置格式。`);
                        }
                    } catch (error) {
                        const message = error instanceof Error ? error.message : '未知错误';
                        errors.push(`${file.name}: ${message}`);
                    }
                }

                if (importedCount > 0) {
                    onShowToast(`${importedCount} 个配置已成功导入！`);
                }
                if (errors.length > 0) {
                    alert(`导入过程中出现错误：\n\n${errors.join('\n')}`);
                }
                
                e.target.value = '';
            };

            const handleFetchModels = async () => {
                setIsFetchingModels(true);
                try {
                    const models = await fetchModels(currentSettings.apiUrl, currentSettings.apiKey);
                    setAvailableModels(models);
                     if (models.length > 0) {
                        onShowToast('模型列表获取成功！');
                        if (!models.includes(currentSettings.apiModel)) {
                            setCurrentSettings(prev => ({ ...prev, apiModel: models[0] }));
                        }
                    } else {
                        onShowToast('获取成功，但未找到可用模型。');
                    }
                } catch (error) {
                    alert(`获取模型列表失败: ${error instanceof Error ? error.message : '未知错误'}`);
                    setAvailableModels([]);
                } finally {
                    setIsFetchingModels(false);
                }
            };

            const FullscreenEditor = ({ prompt, onSave, onClose, onOptimize, isOptimizing, onStopOptimize }) => {
                const [content, setContent] = useState(prompt.content);

                const handleSave = () => {
                    onSave(prompt.key, content);
                };

                const handleOptimizeClick = () => {
                    if (content !== prompt.content) {
                        alert('请先点击确认修改');
                        return;
                    }
                    onOptimize(prompt.key, content, setContent);
                };

                return React.createElement('div', { className: 'fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm' },
                    React.createElement('div', { className: 'ios-card w-full max-w-4xl h-[90vh] flex flex-col' },
                        React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                            React.createElement('div', { className: 'flex justify-between items-center' },
                                React.createElement('h2', { className: 'text-xl font-bold' }, `编辑: ${prompt.label}`),
                                React.createElement('div', { className: 'flex items-center gap-2' },
                                    React.createElement('button', { onClick: handleSave, className: 'icon-button w-10 h-10 flex items-center justify-center hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '保存' },
                                        React.createElement('i', { className: 'fa-solid fa-check text-xl' })
                                    ),
                                    React.createElement('button', { onClick: onClose, className: 'icon-button w-10 h-10 flex items-center justify-center hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭' },
                                       React.createElement('i', { className: 'fa-solid fa-xmark text-xl' })
                                    ),
                                    isOptimizing
                                        ? React.createElement('button', { 
                                            onClick: onStopOptimize,
                                            className: 'icon-button w-10 h-10 flex items-center justify-center hover:bg-gray-200 rounded-lg transition-colors text-[var(--danger-bg)]', 'aria-label': '停止优化'
                                          }, React.createElement('i', { className: 'fa-solid fa-stop text-xl' }))
                                        : React.createElement('button', { 
                                            onClick: handleOptimizeClick,
                                            className: 'icon-button w-10 h-10 flex items-center justify-center hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '智能优化'
                                          }, React.createElement('i', { className: 'fa-solid fa-wand-magic-sparkles text-xl' }))
                                )
                            )
                        ),
                        React.createElement('div', { className: 'p-5 flex-grow min-h-0' },
                            React.createElement('textarea', {
                                value: content,
                                onChange: e => setContent(e.target.value),
                                className: 'w-full h-full border-2 border-[var(--border-color)] rounded-lg p-3 text-base resize-none bg-[var(--card-bg)] focus:outline-none focus:border-[var(--accent-color)] focus:ring-2 focus:ring-[var(--accent-color)]/20 mono',
                                placeholder: '输入内容...'
                            })
                        )
                    )
                );
            };

            const ExportModal = ({ onExportCurrent, onExportAll, onClose }) => {
                return React.createElement('div', { className: 'fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm' },
                    React.createElement('div', { className: 'ios-card w-full max-w-sm flex flex-col p-5' },
                        React.createElement('h3', { className: 'text-lg font-semibold mb-4 text-center' }, '选择导出选项'),
                        React.createElement('div', { className: 'space-y-3' },
                            React.createElement('button', { onClick: () => { onExportCurrent(); onClose(); }, className: 'ios-button w-full h-11' }, '仅导出当前配置'),
                            React.createElement('button', { onClick: () => { onExportAll(); onClose(); }, className: 'ios-button w-full h-11' }, '导出所有配置'),
                            React.createElement('button', { onClick: onClose, className: 'ios-button ios-button-secondary w-full h-11' }, '取消')
                        )
                    )
                );
            };

            return (
                React.createElement(React.Fragment, null,
                    React.createElement('div', { className: `slide-panel fixed top-0 right-0 w-full max-w-md h-full bg-[var(--bg-color)] shadow-xl z-50 flex flex-col transform ${isOpen ? 'translate-x-0' : 'translate-x-full'}`},
                        React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                            React.createElement('div', { className: 'flex justify-between items-center' },
                                React.createElement('h2', { className: 'text-xl font-bold' }, '设置'),
                                React.createElement('button', { onClick: onClose, className: 'icon-button p-2 text-2xl font-bold hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭设置' }, '×')
                            )
                        ),
                        React.createElement('div', { className: 'p-5 overflow-y-auto flex-grow' },
                            React.createElement('div', { className: 'space-y-6' },
                                React.createElement('div', { className: 'ios-card p-5' },
                                    React.createElement('h3', { className: 'text-lg font-semibold mb-3' }, '配置管理'),
                                    React.createElement('div', { className: 'space-y-3' },
                                        React.createElement('div', null,
                                            React.createElement('label', { htmlFor: 'profile-select', className: 'block text-sm font-medium text-gray-700 mb-1' }, '当前配置'),
                                            React.createElement('select', { id: 'profile-select', value: activeProfile.id, onChange: (e) => onSwitch(e.target.value), className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base h-11' },
                                                profiles.map(p => React.createElement('option', { key: p.id, value: p.id }, p.name))
                                            )
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { htmlFor: 'maxHistory', className: 'block text-sm font-medium text-gray-700 mb-1' }, '历史会话记录最大条数(1-50)'),
                                            React.createElement('input', { 
                                                type: 'number', 
                                                id: 'maxHistory', 
                                                name: 'maxHistory', 
                                                value: currentSettings.maxHistory ?? '', 
                                                onChange: handleChange, 
                                                className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base h-11',
                                                placeholder: '1-50'
                                            })
                                        ),
                                        React.createElement('div', { className: 'flex gap-2' },
                                            React.createElement('input', { type: 'text', value: newProfileName, onChange: (e) => setNewProfileName(e.target.value), placeholder: '新配置名称', className: 'flex-grow p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base h-11' }),
                                            React.createElement('button', { onClick: handleSaveNewProfile, className: 'ios-button ios-button-secondary px-3 h-11' }, '创建')
                                        ),
                                        React.createElement('div', { className: 'grid grid-cols-2 gap-2'},
                                            React.createElement('button', { onClick: () => onRename(activeProfile.id), className: 'ios-button ios-button-secondary w-full h-11' }, '重命名当前配置'),
                                            React.createElement('button', { onClick: () => onDelete(activeProfile.id), className: 'ios-button danger w-full h-11' }, '删除当前配置')
                                        )
                                    )
                                ),
                                React.createElement('div', { className: 'ios-card p-5' },
                                    React.createElement('h3', { className: 'text-lg font-semibold mb-3' }, 'API 配置'),
                                    React.createElement('div', { className: 'space-y-3' },
                                        React.createElement('div', null,
                                            React.createElement('label', { htmlFor: 'apiUrl', className: 'block text-sm font-medium text-gray-700 mb-1' }, 'API 链接'),
                                            React.createElement('input', { type: 'url', id: 'apiUrl', name: 'apiUrl', value: currentSettings.apiUrl, onChange: handleChange, className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base', placeholder: 'https://generativelanguage.googleapis.com/v1beta' })
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('label', { htmlFor: 'apiKey', className: 'block text-sm font-medium text-gray-700 mb-1' }, 'API Key'),
                                            React.createElement('input', { type: 'password', id: 'apiKey', name: 'apiKey', value: currentSettings.apiKey, onChange: handleChange, className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base', placeholder: 'Enter your API Key' })
                                        ),
                                        React.createElement('button', { onClick: handleFetchModels, disabled: isFetchingModels || !currentSettings.apiUrl || !currentSettings.apiKey, className: 'ios-button ios-button-secondary w-full flex items-center justify-center gap-2 h-11' },
                                            React.createElement('span', null, isFetchingModels ? '获取中...' : '获取可用模型'),
                                            isFetchingModels && React.createElement('div', { className: 'small-loader' })
                                        ),
                                        availableModels.length > 0 && (
                                            React.createElement('div', null,
                                                React.createElement('label', { htmlFor: 'apiModel', className: 'block text-sm font-medium text-gray-700 mb-1' }, '选择模型'),
                                                React.createElement('select', { id: 'apiModel', name: 'apiModel', value: currentSettings.apiModel, onChange: handleChange, className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base' },
                                                    React.createElement('option', { value: '' }, '请选择模型'),
                                                    availableModels.map(m => React.createElement('option', { key: m, value: m }, m))
                                                )
                                            )
                                        )
                                    )
                                ),
                                ...promptFields.map(({key, label, description, placeholder}) => (
                                    React.createElement('div', { key: key, className: 'ios-card p-5 relative' },
                                        React.createElement('button', {
                                            onClick: () => setFullscreenPrompt({ key, label, content: currentSettings[key] }),
                                            className: 'absolute top-4 right-4 text-gray-400 hover:text-[var(--accent-color)] transition-colors z-10 p-2',
                                            'aria-label': '全屏编辑'
                                        }, React.createElement('i', { className: 'fa-solid fa-maximize' })),
                                        React.createElement('label', { htmlFor: key, className: 'block text-lg font-semibold mb-3' }, label),
                                        React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, description),
                                        React.createElement('textarea', { id: key, name: key, value: currentSettings[key], onChange: handleChange, className: 'w-full border-2 border-[var(--border-color)] rounded-lg p-3 text-base resize-vertical min-h-[120px] bg-[var(--card-bg)] focus:outline-none focus:border-[var(--accent-color)] focus:ring-2 focus:ring-[var(--accent-color)]/20', placeholder: placeholder }),
                                        React.createElement('input', { type: 'file', id: `${key}-upload`, className: 'hidden', accept: '.txt,.md,.yaml,.yml,.sql,.xlsx,.xls', onChange: (e) => handleFileChange(e, key) }),
                                        React.createElement('div', { className: 'mt-3 grid grid-cols-2 gap-2' },
                                            React.createElement('button', { onClick: () => document.getElementById(`${key}-upload`)?.click(), className: 'ios-button ios-button-secondary w-full h-11' }, '上传文件'),
                                            optimizingState.key === key
                                                ? React.createElement('button', { 
                                                    onClick: handleStopOptimization, 
                                                    className: 'ios-button danger w-full flex items-center justify-center gap-2 h-11' 
                                                }, React.createElement('i', { className: 'fa-solid fa-stop' }), '停止优化')
                                                : React.createElement('button', {
                                                    onClick: () => handleOptimizePrompt(key, null, (newContent) => setCurrentSettings(prev => ({...prev, [key]: newContent}))),
                                                    className: 'ios-button ios-button-secondary w-full flex items-center justify-center gap-2 h-11',
                                                    disabled: optimizingState.key !== null,
                                                }, React.createElement('i', { className: 'fa-solid fa-wand-magic-sparkles' }), React.createElement('span', null, '智能优化'))
                                        )
                                    )
                                ))
                            )
                        ),
                        React.createElement('div', { className: 'p-4 border-t border-[var(--border-color)] flex-shrink-0 bg-[var(--card-bg)]' },
                            React.createElement('div', { className: 'mx-auto grid gap-2' },
                                React.createElement('button', { onClick: handleSave, className: 'ios-button w-full h-11' }, '保存设置'),
                                React.createElement('button', { onClick: handleResetCurrentSettings, className: 'ios-button danger w-full h-11' }, '清除配置信息'),
                                React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                    React.createElement('button', { onClick: () => setIsExportModalOpen(true), className: 'ios-button ios-button-secondary w-full h-11' }, '导出设置'),
                                    React.createElement('button', { onClick: () => importFileRef.current?.click(), className: 'ios-button ios-button-secondary w-full h-11' }, '导入设置'),
                                    React.createElement('input', { type: 'file', ref: importFileRef, onChange: handleImport, className: 'hidden', accept: '.json', multiple: true })
                                )
                            )
                        )
                    ),
                    fullscreenPrompt && React.createElement(FullscreenEditor, {
                        prompt: fullscreenPrompt,
                        onSave: (key, newContent) => {
                            setCurrentSettings(prev => ({ ...prev, [key]: newContent }));
                            onShowToast(`"${promptFields.find(f => f.key === key)?.label}" 已保存!`);
                        },
                        onClose: () => setFullscreenPrompt(null),
                        onOptimize: handleOptimizePrompt,
                        isOptimizing: optimizingState.key === fullscreenPrompt.key,
                        onStopOptimize: handleStopOptimization
                    }),
                    isExportModalOpen && React.createElement(ExportModal, {
                        onExportCurrent: onExport,
                        onExportAll: onExportAll,
                        onClose: () => setIsExportModalOpen(false)
                    })
                )
            );
        };
        
        // --- From components/HistoryPanel.tsx ---
        const CodeBlockWithCopy = ({ code }) => {
            const { useState, useRef, useEffect } = React;
            const [copyText, setCopyText] = useState('复制');
            const preRef = useRef(null);
            
            useEffect(() => {
                if (preRef.current && window.Prism && code && code !== '无有效 SQL') {
                    const codeElement = preRef.current.querySelector('code');
                    if (codeElement) {
                        // 应用SQL语法高亮
                        codeElement.className = 'language-sql text-xs';
                        window.Prism.highlightElement(codeElement);
                    }
                }
            }, [code]);
            
            const handleCopy = () => {
                if (!code || code === '无有效 SQL') {
                    setCopyText('无内容');
                    setTimeout(() => setCopyText('复制'), 2000);
                    return;
                }
                navigator.clipboard.writeText(code).then(() => {
                    setCopyText('已复制!');
                    setTimeout(() => setCopyText('复制'), 2000);
                }).catch(err => {
                    setCopyText('失败!');
                    console.error('Failed to copy code: ', err);
                    setTimeout(() => setCopyText('复制'), 2000);
                });
            };

            const icon = copyText === '已复制!' 
                ? React.createElement('i', { className: 'fa-solid fa-check mr-1' })
                : React.createElement('i', { className: 'fa-regular fa-clipboard mr-1' });

            return React.createElement('div', { className: 'relative' },
                React.createElement('button', {
                    onClick: handleCopy,
                    className: 'copy-code-button ios-button ios-button-secondary text-sm font-semibold py-1 px-3 absolute top-2 right-2 z-10'
                }, 
                    icon,
                    ` ${copyText}`
                ),
                React.createElement('pre', {
                    ref: preRef,
                    className: 'mt-2 p-3 pt-12 bg-gray-800 text-white rounded-lg overflow-y-auto mono text-xs whitespace-pre-wrap word-break-all max-h-48'
                }, 
                    React.createElement('code', { className: 'language-sql text-xs' }, code)
                )
            );
        };
        
        const HistoryItem = ({ item, index, total, onLoadConversation, onDeleteItem }) => {
            const [isExpanded, setIsExpanded] = React.useState(false);
            const initialRequest = item.conversation.find(m => m.role === 'user')?.content || '无初始请求';
            const finalSql = [...item.conversation].reverse().find(m => m.role === 'assistant' && !m.isError)?.content?.match(/```(?:sql)?\n([\s\S]+?)```/g)?.pop()?.replace(/```(?:sql)?\n|\n```/g, '') || '无有效 SQL';
        
            return React.createElement('div', { key: item.time, className: 'ios-card p-4 mb-3' },
                React.createElement('div', { className: 'flex items-start justify-between gap-3' },
                    React.createElement('div', { className: 'flex-1' },
                        React.createElement('div', { className: 'text-xs text-[var(--accent-color)]' }, `#${total - index} · ${new Date(item.time).toLocaleString()}`),
                        React.createElement('div', { className: 'mt-1 text-sm' }, React.createElement('span', {className: 'font-semibold'}, '初始需求：'), initialRequest.slice(0, 200) + (initialRequest.length > 200 ? '...' : ''))
                    )
                ),
                React.createElement('div', { className: 'mt-2' },
                    React.createElement('button', { 
                        className: 'text-sm font-medium flex items-center w-full text-left',
                        onClick: () => setIsExpanded(!isExpanded)
                    },
                        React.createElement('span', { 
                            className: `details-arrow ${isExpanded ? 'expanded' : ''}` 
                        }),
                        React.createElement('span', { className: 'summary-text' }, '查看最终 SQL')
                    ),
                    React.createElement('div', { 
                        className: `sql-preview-container ${isExpanded ? 'expanded' : ''}` 
                    },
                        React.createElement(CodeBlockWithCopy, { code: finalSql })
                    )
                ),
                React.createElement('div', { className: 'mt-3 flex gap-2 items-stretch' },
                    React.createElement('button', { onClick: () => onLoadConversation(item.conversation, item.time), className: 'ios-button text-sm px-4 py-2 flex-1' }, '加载对话'),
                    React.createElement('button', { onClick: () => onDeleteItem(item.time), className: 'ios-button danger text-sm px-4 py-2 flex-1' }, '删除对话')
                )
            );
        };

        const HistoryPanel = ({ isOpen, onClose, history, setHistory, onLoadConversation, maxHistory }) => {
            const importFileRef = useRef(null);
            const [searchTerm, setSearchTerm] = React.useState('');

            const filteredHistory = React.useMemo(() => {
                return history.filter(item => {
                    if (!searchTerm.trim()) return true;
                    const lowerCaseSearch = searchTerm.toLowerCase();
                    return item.conversation.some(msg => 
                        msg.content && msg.content.toLowerCase().includes(lowerCaseSearch)
                    );
                });
            }, [history, searchTerm]);

            const clearHistory = () => {
                if (window.confirm('确定清空所有历史记录吗？')) {
                    setHistory([]);
                }
            };
            
            const deleteItem = (timestamp) => {
                if (window.confirm('确定删除这条历史记录吗？')) {
                    setHistory(prev => prev.filter(item => item.time !== timestamp));
                }
            };

            const loadConversation = (conversation, time) => {
                onLoadConversation(conversation, time);
                onClose();
            };
            
            const handleExport = () => {
                if (history.length === 0) {
                    alert('没有历史记录可以导出。');
                    return;
                }
                downloadAsJson(history, 'sql_assistant_history.json');
            };

            const handleImport = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                if (!window.confirm('这将替换您当前的历史记录。要继续吗？')) {
                    e.target.value = '';
                    return;
                }

                try {
                    const importedHistory = await readJsonFile(file);
                    if (Array.isArray(importedHistory) && importedHistory.every(item => 'conversation' in item && 'time' in item)) {
                        setHistory(importedHistory.slice(0, maxHistory));
                        alert('历史记录导入成功！');
                    } else {
                        throw new Error('文件内容不是有效的历史记录格式。');
                    }
                } catch (error) {
                    const message = error instanceof Error ? error.message : '未知错误';
                    alert(`导入失败: ${message}`);
                } finally {
                    e.target.value = '';
                }
            };

            return (
                React.createElement('aside', { className: `slide-panel fixed top-0 left-0 w-full max-w-lg h-full bg-[var(--bg-color)] shadow-xl z-50 flex flex-col transform ${isOpen ? 'translate-x-0' : '-translate-x-full'}` },
                    React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                        React.createElement('div', { className: 'flex justify-between items-center' },
                            React.createElement('h2', { className: 'text-xl font-bold' }, `历史记录 (最近${maxHistory}条)`),
                            React.createElement('button', { onClick: onClose, className: 'icon-button p-2 text-2xl font-bold hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭历史' }, '×')
                        )
                    ),
                    React.createElement('div', { className: 'p-5 overflow-y-auto flex-grow' },
                         React.createElement('div', { className: 'mb-4' },
                            React.createElement('input', {
                                type: 'search',
                                placeholder: '通过关键词搜索...',
                                value: searchTerm,
                                onChange: e => setSearchTerm(e.target.value),
                                className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base'
                            })
                        ),
                        history.length === 0 ? (
                            React.createElement('p', { className: 'text-sm text-gray-500' }, '暂无历史记录。')
                        ) : filteredHistory.length === 0 ? (
                             React.createElement('p', { className: 'text-sm text-gray-500' }, '未找到匹配的记录。')
                        ) : (
                            filteredHistory.map((h, idx) => React.createElement(HistoryItem, {
                                key: h.time,
                                item: h,
                                index: idx,
                                total: filteredHistory.length,
                                onLoadConversation: loadConversation,
                                onDeleteItem: deleteItem
                            }))
                        )
                    ),
                    React.createElement('div', { className: 'p-4 border-t border-[var(--border-color)] flex-shrink-0 bg-[var(--card-bg)]' },
                        React.createElement('div', { className: 'mx-auto grid gap-2' },
                            React.createElement('button', { onClick: clearHistory, className: 'ios-button danger w-full', disabled: history.length === 0 }, '清空历史'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                React.createElement('button', { onClick: handleExport, className: 'ios-button ios-button-secondary w-full', disabled: history.length === 0 }, '导出历史'),
                                React.createElement('button', { onClick: () => importFileRef.current?.click(), className: 'ios-button ios-button-secondary w-full' }, '导入历史')
                            ),
                            React.createElement('input', { type: 'file', ref: importFileRef, onChange: handleImport, className: 'hidden', accept: '.json' })
                        )
                    )
                )
            );
        };

        // --- From components/ConsolePanel.tsx ---
        const ConsolePanel = ({ isOpen, onClose, logs, onClearLogs }) => {
            const logsContainerRef = useRef(null);
            
            useEffect(() => {
                if (isOpen && logsContainerRef.current) {
                    logsContainerRef.current.scrollTop = logsContainerRef.current.scrollHeight;
                }
            }, [logs, isOpen]);

            const levelColor = {
                log: 'text-gray-500',
                warn: 'text-yellow-500',
                error: 'text-red-500',
                info: 'text-blue-500',
            };

            return React.createElement('aside', { className: `slide-panel fixed top-0 left-0 w-full max-w-lg h-full bg-[var(--bg-color)] shadow-xl z-50 flex flex-col transform ${isOpen ? 'translate-x-0' : '-translate-x-full'}` },
                React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                    React.createElement('div', { className: 'flex justify-between items-center' },
                        React.createElement('h2', { className: 'text-xl font-bold' }, '控制台'),
                        React.createElement('button', { onClick: onClose, className: 'icon-button p-2 text-2xl font-bold hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭控制台' }, '×')
                    )
                ),
                React.createElement('div', { ref: logsContainerRef, className: 'p-5 overflow-y-auto flex-grow' },
                    logs.length === 0 ? (
                        React.createElement('p', { className: 'text-sm text-gray-500' }, '暂无控制台信息。')
                    ) : (
                        React.createElement('div', { className: 'space-y-2' },
                            logs.map((log, index) =>
                                React.createElement('div', { key: index, className: 'p-2 bg-[var(--card-bg)] rounded-lg border border-[var(--border-color)]' },
                                    React.createElement('div', { className: 'flex justify-between items-center text-xs text-gray-400 mb-1' },
                                        React.createElement('span', { className: `font-bold uppercase ${levelColor[log.level] || 'text-gray-500'}` }, log.level),
                                        React.createElement('span', null, new Date(log.time).toLocaleTimeString())
                                    ),
                                    React.createElement('pre', { className: 'whitespace-pre-wrap break-words text-sm mono' }, log.message)
                                )
                            )
                        )
                    )
                ),
                React.createElement('div', { className: 'p-4 border-t border-[var(--border-color)] flex-shrink-0 bg-[var(--card-bg)]' },
                    React.createElement('div', { className: 'mx-auto' },
                        React.createElement('button', { onClick: onClearLogs, className: 'ios-button danger w-full', disabled: logs.length === 0 }, '清空控制台')
                    )
                )
            );
        };
        
        // --- From components/TutorialPanel.tsx ---
        const TutorialPanel = ({ isOpen, onClose }) => {
            const Section = ({ title, children }) => React.createElement('div', { className: 'ios-card p-5' },
                React.createElement('h3', { className: 'text-lg font-semibold mb-3 text-[var(--accent-color)]' }, title),
                React.createElement('div', { className: 'text-sm text-gray-600 space-y-2' }, children)
            );

            const Tip = ({ title, children }) => React.createElement('div', { className: 'mt-4 p-3 bg-[var(--info-bg)] border-l-4 border-[var(--info-border)] rounded-r-lg' },
                React.createElement('p', { className: 'font-semibold text-[var(--info-border)]' }, title),
                React.createElement('p', { className: 'mt-1' }, children)
            );

            return React.createElement('div', { className: `slide-panel fixed top-0 right-0 w-full max-w-md h-full bg-[var(--bg-color)] shadow-xl z-50 flex flex-col transform ${isOpen ? 'translate-x-0' : 'translate-x-full'}`},
                React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                    React.createElement('div', { className: 'flex justify-between items-center' },
                        React.createElement('h2', { className: 'text-xl font-bold' }, '教程与提示'),
                        React.createElement('button', { onClick: onClose, className: 'icon-button p-2 text-2xl font-bold hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭教程' }, '×')
                    )
                ),
                React.createElement('div', { className: 'p-5 overflow-y-auto flex-grow space-y-6' },
                    React.createElement(Section, { title: '基础功能' },
                        React.createElement('p', null, '欢迎使用 SQL 自动化编写助手！本工具旨在帮助您通过自然语言快速生成和优化 SQL 查询。'),
                        React.createElement('ul', { className: 'list-disc list-inside space-y-1' },
                            React.createElement('li', null, React.createElement('strong', null, '对话式生成: '), '在下方的输入框中输入数据需求，点击发送即可生成 SQL。'),
                            React.createElement('li', null, React.createElement('strong', null, '图片上传: '), '点击输入框旁的图片图标，可以上传图片与文字一同分析 (仅支持 Gemini 等识图模型)。'),
                            React.createElement('li', null, React.createElement('strong', null, '持续优化: '), '可以继续输入指令，对已生成的 SQL 进行修改，例如 "添加 xx 条件" 或 "按 xx 排序"。'),
                            React.createElement('li', null, React.createElement('strong', null, '编辑与重生成: '), '将鼠标悬停在消息上可点击铅笔图标进行编辑。也可以点击 "重新生成" 按钮让 AI 重新回答最后一个问题。'),
                            React.createElement('li', null, React.createElement('strong', null, '复制代码块: '), 'AI 回复的代码块右上角会出现复制按钮，方便一键复制代码。'),
                            React.createElement('li', null, React.createElement('strong', null, '新对话: '), '点击标题栏左侧的 "+" 图标会将当前对话存入历史记录，并开始一个全新的会话。'),
                            React.createElement('li', null, React.createElement('strong', null, '历史记录: '), '点击标题栏左侧的时钟图标，可以查看、加载、或删除最近的对话。新增搜索功能，可快速查找历史会话。'),
                            React.createElement('li', null, React.createElement('strong', null, '开发者控制台: '), '点击标题栏左侧的终端图标，可以查看应用的详细日志，便于排查API调用等问题。')
                        )
                    ),
                    React.createElement(Section, { title: '设置面板' },
                         React.createElement('ul', { className: 'list-disc list-inside space-y-1' },
                            React.createElement('li', null, React.createElement('strong', null, '多套配置: '), '点击标题栏右侧的齿轮图标，可以创建多套配置方案，以适应不同的数据库或项目需求。'),
                            React.createElement('li', null, React.createElement('strong', null, '历史记录数量: '), '现在您可以在“配置管理”中设置要保存的最大历史对话条数。'),
                            React.createElement('li', null, React.createElement('strong', null, '自定义 Prompt: '), '通过修改SQL生成规则、数据库结构等信息，可以定制 AI 的行为，使其生成更符合需求的 SQL。支持上传文件 (.txt, .md, .yaml, .sql, .xlsx, .xls)。'),
                            React.createElement('li', null, React.createElement('strong', null, '智能优化: '), '点击 Prompt 输入框下方的 "智能优化" 按钮，可利用 AI 自动将输入或上传的文本内容（如数据库结构、术语定义等）优化为更规整、更易于 AI 理解的 YAML 格式。'),
                             React.createElement('li', null, React.createElement('strong', null, '全屏编辑: '), '点击 Prompt 输入框右上角的放大图标，可以在一个更大的、更专注的视图中编辑内容。'),
                             React.createElement('li', null, React.createElement('strong', null, '批量导入/导出: '), '可以一次性选择多个配置文件进行导入。导出时，也可以选择仅导出当前配置或一次性导出所有配置的多个对应json文件。'),
                            React.createElement('li', null, React.createElement('strong', null, 'API 设置: '), '在这里配置 API 服务地址和 Key。点击 "获取可用模型" 按钮将自动拉取并填充模型列表。')
                        ),
                        React.createElement(Tip, { title: '高级提示：使用 YAML 格式' },
                            '在 "数据库表结构" 或 "行业术语定义" 等信息中，使用清晰的 YAML 格式可以让 AI 更准确地理解和记忆上下文信息，从而提高生成质量。智能优化功能可以快速完成转换。'
                        )
                    ),
                    React.createElement(Section, { title: '移动端体验优化' },
                        React.createElement('ul', { className: 'list-disc list-inside space-y-1' },
                            React.createElement('li', null, React.createElement('strong', null, '界面自适应: '), '本应用界面已为移动设备优化，会自动调整布局以适应手机或平板屏幕。'),
                            React.createElement('li', null, React.createElement('strong', null, '添加到主屏幕 (PWA): '), 'iOS 用户可以在 Safari 浏览器中点击分享按钮，然后选择 "添加到主屏幕"，即可像原生 App 一样使用本工具，获得沉浸式全屏体验。')
                        )
                    ),
                    React.createElement(Section, { title: 'API URL 支持格式' },
                        React.createElement('p', null, '本工具支持多种 API 格式：'),
                        React.createElement('ul', { className: 'list-disc list-inside space-y-1' },
                            React.createElement('li', null, React.createElement('strong', null, 'Google Gemini: '), '官方标准链接，例如 ', React.createElement('code', {className: 'text-xs bg-[var(--accent-light)] text-[var(--accent-dark)] p-1 rounded'}, 'https://generativelanguage.googleapis.com/v1beta')),
                            React.createElement('li', null, React.createElement('strong', null, 'OpenAI 兼容格式: '), '任何兼容 OpenAI 聊天接口的 API。程序会自动在链接后拼接 ', React.createElement('code', {className: 'text-xs bg-[var(--accent-light)] text-[var(--accent-dark)] p-1 rounded'}, '/chat/completions'), '。请提供基础 URL，例如 ', React.createElement('code', {className: 'text-xs bg-[var(--accent-light)] text-[var(--accent-dark)] p-1 rounded'}, 'https://api.example.com/v1'))
                        )
                    )
                )
            );
        };

        // --- From App.tsx ---
        const ChatImagePreview = ({ image, onRemove, onPreview }) => {
            if (!image) return null;
            return React.createElement('div', { className: 'relative mb-2 w-24 h-24' },
                React.createElement('img', { 
                    src: image.dataUrl, 
                    alt: '上传的图片预览', 
                    className: 'w-full h-full object-cover rounded-lg border border-[var(--border-color)] cursor-pointer',
                    onClick: () => onPreview(image.dataUrl)
                }),
                React.createElement('button', {
                    onClick: onRemove,
                    className: 'absolute -top-2 -right-2 bg-[var(--danger-bg)] text-white w-6 h-6 rounded-full flex items-center justify-center shadow-md hover:bg-[var(--danger-hover-bg)] transition',
                    'aria-label': '移除图片'
                }, React.createElement('i', { className: 'fa-solid fa-xmark' }))
            );
        };

        const App = () => {
            const [isMounted, setIsMounted] = useState(false);
            const [isSettingsOpen, setSettingsOpen] = useState(false);
            const [isHistoryOpen, setHistoryOpen] = useState(false);
            const [isTutorialOpen, setTutorialOpen] = useState(false);
            const [isConsoleOpen, setConsoleOpen] = useState(false);
            const [consoleLogs, setConsoleLogs] = useState([]);
            const [theme, setTheme] = useLocalStorage(LOCAL_STORAGE_THEME_KEY, 'light');
            const [toastMessage, setToastMessage] = useState(null);
            
            const [profiles, setProfiles] = useLocalStorage(LOCAL_STORAGE_PROFILES_KEY, [DEFAULT_PROFILE]);
            const [activeProfileId, setActiveProfileId] = useLocalStorage(LOCAL_STORAGE_ACTIVE_PROFILE_ID_KEY, DEFAULT_PROFILE.id);
            const [history, setHistory] = useLocalStorage(LOCAL_STORAGE_HISTORY_KEY, []);
            const [userQuery, setUserQuery] = useState('');
            const [conversation, _setConversation] = useLocalStorage(LOCAL_STORAGE_ACTIVE_CONVERSATION_KEY, []);
            const [activeHistoryId, setActiveHistoryId] = useLocalStorage(LOCAL_STORAGE_ACTIVE_HISTORY_ID_KEY, null);
            const [previewImageUrl, setPreviewImageUrl] = useState(null);

            const [isLoading, setIsLoading] = useState(false);
            const [editingIndex, setEditingIndex] = useState(null);
            const [editedContent, setEditedContent] = useState('');
            const [editedImage, setEditedImage] = useState(null);
            const [chatImage, setChatImage] = useState(null);
            const abortControllerRef = useRef(null);
            const imageInputRef = useRef(null);

            const isLastMessageFromUser = useMemo(() => {
                return conversation.length > 0 && conversation[conversation.length - 1].role === 'user';
            }, [conversation]);
            
            useEffect(() => {
                const originalConsole = { ...window.console };
                const formatMessage = (args) => args.map(arg => {
                    try {
                        if (arg instanceof Error) {
                            return `Error: ${arg.message}\n${arg.stack}`;
                        }
                        return typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg);
                    } catch (e) {
                        return '[Unserializable Object]';
                    }
                }).join(' ');

                const overrideConsole = (level) => {
                    const originalMethod = window.console[level];
                    window.console[level] = (...args) => {
                        originalMethod.apply(window.console, args); // Preserve 'this' context
                        setConsoleLogs(prevLogs => [
                            ...prevLogs,
                            {
                                level,
                                message: formatMessage(args),
                                time: new Date().toISOString()
                            }
                        ].slice(-100));
                    };
                };

                const levels = ['log', 'warn', 'error', 'info'];
                levels.forEach(overrideConsole);

                return () => {
                    levels.forEach(level => {
                        window.console[level] = originalConsole[level];
                    });
                };
            }, []);

            const activeProfile = useMemo(() => {
                return profiles.find(p => p.id === activeProfileId) || profiles[0] || DEFAULT_PROFILE;
            }, [profiles, activeProfileId]);
            
            const setConversation = useCallback((newConversationOrUpdater) => {
                _setConversation(prevConversation => {
                    const newConversation = typeof newConversationOrUpdater === 'function'
                        ? newConversationOrUpdater(prevConversation)
                        : newConversationOrUpdater;
            
                    return newConversation;
                });
            }, [_setConversation]);

            const saveConversationToHistory = useCallback((conversation) => {
                if (conversation.length === 0 || !conversation.some(m => m.role === 'user')) {
                    return;
                }
                
                const lastMessage = conversation[conversation.length - 1];
                if (lastMessage && lastMessage.isStreaming) {
                    return;
                }

                const maxHistory = activeProfile.settings.maxHistory || 10;
            
                setActiveHistoryId(prevId => {
                    let currentId = prevId;
                    if (currentId) {
                        setHistory(prevHistory => {
                            const exists = prevHistory.some(item => item.time === currentId);
                            if (exists) {
                                return prevHistory.map(item => item.time === currentId ? 
                                    { ...item, conversation: conversation } : item);
                            } else {
                                currentId = Date.now();
                                return [{ conversation: conversation, time: currentId }, ...prevHistory].slice(0, maxHistory);
                            }
                        });
                    } else {
                        currentId = Date.now();
                        setHistory(prevHistory => [{ conversation: conversation, time: currentId }, ...prevHistory].slice(0, maxHistory));
                    }
                    return currentId;
                });
            }, [setHistory, activeProfile.settings.maxHistory, setActiveHistoryId]);

            useEffect(() => {
                saveConversationToHistory(conversation);
            }, [conversation, saveConversationToHistory]);

            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [theme]);
            
            const showToast = useCallback((message) => {
                setToastMessage(message);
                setTimeout(() => setToastMessage(null), 3000);
            }, []);

            const handleClosePanels = useCallback(() => {
                setSettingsOpen(false);
                setHistoryOpen(false);
                setTutorialOpen(false);
                setConsoleOpen(false);
            }, []);

            const handleToggleSettings = useCallback((open) => {
                const nextState = open ?? !isSettingsOpen;
                setSettingsOpen(nextState);
                if (nextState) { setHistoryOpen(false); setTutorialOpen(false); setConsoleOpen(false); }
            }, [isSettingsOpen]);

            const handleToggleHistory = useCallback((open) => {
                const nextState = open ?? !isHistoryOpen;
                setHistoryOpen(nextState);
                if (nextState) { setSettingsOpen(false); setTutorialOpen(false); setConsoleOpen(false); }
            }, [isHistoryOpen]);

            const handleToggleConsole = useCallback((open) => {
                const nextState = open ?? !isConsoleOpen;
                setConsoleOpen(nextState);
                if (nextState) { setSettingsOpen(false); setTutorialOpen(false); setHistoryOpen(false); }
            }, [isConsoleOpen]);
            
            const handleToggleTutorial = useCallback((open) => {
                const nextState = open ?? !isTutorialOpen;
                setTutorialOpen(nextState);
                if (nextState) { setSettingsOpen(false); setHistoryOpen(false); setConsoleOpen(false); }
            }, [isTutorialOpen]);
            
            const handleToggleTheme = useCallback(() => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            }, [setTheme]);

            const handleStop = () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }
            };

            const handleRemoveEditedImage = () => setEditedImage(null);

            const handleCancelEdit = () => {
                setEditingIndex(null);
                setEditedContent('');
                setEditedImage(null);
            };

            const handleNewChat = useCallback(() => {
                _setConversation([]);
                setUserQuery('');
                setChatImage(null);
                setActiveHistoryId(null);
                handleStop();
                handleCancelEdit();
            }, [_setConversation, setActiveHistoryId]);

            const handleLoadConversationFromHistory = useCallback((conversationToLoad, historyId) => {
                _setConversation(conversationToLoad);
                setActiveHistoryId(historyId);
            }, [_setConversation, setActiveHistoryId]);

            const runGeneration = useCallback(async (chatHistoryForApi, isRegeneration = false, regenerationIndex = -1) => {
                try {
                    const activeSettings = activeProfile.settings;
                    if (!activeSettings.apiUrl || !activeSettings.apiKey) {
                        alert('请先在设置中配置API！');
                        handleToggleSettings(true);
                        return;
                    }
                    
                    setIsLoading(true);
                    abortControllerRef.current = new AbortController();
            
                    const baseUpdater = (prev) => {
                        const conversationSlice = isRegeneration ? prev.slice(0, regenerationIndex + 1) : prev;
                        return [...conversationSlice, { role: 'assistant', content: '', isStreaming: true }];
                    };
                    isRegeneration ? _setConversation(baseUpdater) : setConversation(baseUpdater);
                    
                    const onChunk = (chunk) => {
                        _setConversation(prev => {
                            const lastMessage = prev[prev.length - 1];
                            if (lastMessage && lastMessage.role === 'assistant') {
                                const updatedLastMessage = { ...lastMessage, content: lastMessage.content + chunk };
                                return [...prev.slice(0, -1), updatedLastMessage];
                            }
                            return prev;
                        });
                    };
                    
                    const onComplete = () => {
                        setConversation(prev => {
                            const lastMessage = prev[prev.length - 1];
                            if (lastMessage && lastMessage.role === 'assistant') {
                                return [...prev.slice(0, -1), { ...lastMessage, isStreaming: false }];
                            }
                            return prev;
                        });
                        setIsLoading(false);
                        abortControllerRef.current = null;
                    };
            
                    const onError = (error) => {
                        setConversation(prev => {
                            const lastMessage = prev[prev.length - 1];
                            const isAbort = error instanceof Error && error.name === 'AbortError';
                            const content = isAbort ? '-- 生成已手动停止 --' : `-- 生成 SQL 时出错 --\n${error.message}`;
                    
                            if (lastMessage && lastMessage.role === 'assistant') {
                                 return [...prev.slice(0, -1), { ...lastMessage, content: (lastMessage.content || '') + `\n\n${content}`, isError: true, isStreaming: false }];
                            }
                            return [...prev, { role: 'assistant', content, isError: true, isStreaming: false }];
                        });
                        setIsLoading(false);
                        abortControllerRef.current = null;
                    };
            
                    await generateSqlStream(
                        chatHistoryForApi,
                        activeSettings,
                        abortControllerRef.current.signal,
                        onChunk,
                        onComplete,
                        onError
                    );
                } catch (error) {
                    console.error('Error in runGeneration:', error);
                    setIsLoading(false);
                    abortControllerRef.current = null;
                    setConversation(prev => [...prev, { 
                        role: 'assistant', 
                        content: `抱歉，处理请求时出现了错误：${error.message}`, 
                        isError: true, 
                        isStreaming: false 
                    }]);
                }
            }, [activeProfile, _setConversation, setConversation]);

            const handleSendMessage = useCallback(async () => {
                const trimmedQuery = userQuery.trim();
                let chatHistoryForApi;

                if (trimmedQuery || chatImage) {
                    const userMessage = { role: 'user', content: trimmedQuery };
                    if (chatImage) {
                        userMessage.image = chatImage;
                    }
                    chatHistoryForApi = [...conversation, userMessage];
                    setConversation(chatHistoryForApi);
                    setUserQuery('');
                    setChatImage(null);
                    
                    const textarea = document.getElementById('user-query');
                    if (textarea) {
                        textarea.style.height = 'auto';
                        const isMobile = window.innerWidth <= 768;
                        textarea.style.height = isMobile ? '80px' : '44px';
                    }
                } else if (isLastMessageFromUser) {
                    chatHistoryForApi = conversation;
                } else {
                    alert('请输入您的需求！');
                    return;
                }
                
                await runGeneration(chatHistoryForApi, false);
            }, [userQuery, chatImage, conversation, setConversation, runGeneration, isLastMessageFromUser]);

            const handleSaveEdit = useCallback(() => {
                if (editingIndex === null) return;
                const trimmedContent = editedContent.trim();
                if (!trimmedContent && !editedImage) {
                    alert('内容和图片不能都为空！');
                    return;
                }
                
                const updatedConversation = [...conversation];
                const originalMessage = updatedConversation[editingIndex];
                const updatedMessage = { 
                    ...originalMessage,
                    content: trimmedContent, 
                    image: editedImage 
                };

                if (!updatedMessage.image) {
                    delete updatedMessage.image;
                }

                updatedConversation[editingIndex] = updatedMessage;
                
                setConversation(updatedConversation);
                setEditingIndex(null);
                setEditedContent('');
                setEditedImage(null);
            }, [editingIndex, editedContent, editedImage, conversation, setConversation]);
            
            const handleSuggestionClick = useCallback(async (prompt) => {
                const trimmedQuery = prompt.trim();
                if (!trimmedQuery || isLoading) return;
            
                try {
                    const userMessage = { role: 'user', content: trimmedQuery };
                    const chatHistoryForApi = [userMessage];
                    
                    setConversation(chatHistoryForApi);
                    setUserQuery('');
                    setChatImage(null);
            
                    await runGeneration(chatHistoryForApi, false);
                } catch (error) {
                    console.error('Error in handleSuggestionClick:', error);
                    setConversation(prev => [...prev, { 
                        role: 'assistant', 
                        content: '抱歉，处理您的请求时出现了错误。请重试或检查设置。', 
                        isError: true, 
                        isStreaming: false 
                    }]);
                }
            }, [isLoading, setConversation, runGeneration]);

            const handleRegenerateLastResponse = useCallback(async () => {
                let lastUserMessageIndex = -1;
                for (let i = conversation.length - 1; i >= 0; i--) {
                    if (conversation[i].role === 'user') {
                        lastUserMessageIndex = i;
                        break;
                    }
                }
                if (lastUserMessageIndex === -1) return;
                
                const textarea = document.getElementById('user-query');
                if (textarea) {
                     textarea.style.height = 'auto';
                    const isMobile = window.innerWidth <= 768;
                    textarea.style.height = isMobile ? '80px' : '44px';
                }

                const chatHistoryForApi = conversation.slice(0, lastUserMessageIndex + 1);
                await runGeneration(chatHistoryForApi, true, lastUserMessageIndex);
            }, [conversation, runGeneration]);

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };
            
            const handleStartEdit = (index, content, image) => {
                setEditingIndex(index);
                setEditedContent(content);
                setEditedImage(image || null);
            };

            const processImageFile = (file, imageSetter) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    const base64Data = dataUrl.split(',')[1];
                    imageSetter({
                        data: base64Data,
                        mimeType: file.type,
                        dataUrl: dataUrl
                    });
                };
                reader.readAsDataURL(file);
            };

            const handleImageUpload = (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    processImageFile(file, setChatImage);
                }
                event.target.value = ''; // Allow re-uploading the same file
            };
            
            const handlePaste = (event) => {
                const items = (event.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) {
                            processImageFile(file, setChatImage);
                            event.preventDefault();
                            return;
                        }
                    }
                }
            };

            const handleSaveProfileSettings = (updatedSettings) => {
                const updatedProfiles = profiles.map(p =>
                    p.id === activeProfileId ? { ...p, settings: updatedSettings } : p
                );
                setProfiles(updatedProfiles);
                showToast('配置已保存！');
                handleClosePanels();
            };
            
            const handleSwitchProfile = (id) => {
                setActiveProfileId(id);
            };

            const handleCreateProfile = (name, settings) => {
                const newProfile = {
                    id: `profile_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name,
                    settings
                };
                const newProfiles = [...profiles, newProfile];
                setProfiles(newProfiles);
                return newProfile;
            };
            
            const handleDeleteProfile = (id) => {
                if (profiles.length <= 1) {
                    alert('无法删除唯一的配置。');
                    return;
                }
                if (window.confirm(`确定要删除配置 "${profiles.find(p=>p.id === id)?.name}" 吗？`)) {
                    const newProfiles = profiles.filter(p => p.id !== id);
                    setProfiles(newProfiles);
                    if (activeProfileId === id) {
                        setActiveProfileId(newProfiles[0].id);
                    }
                }
            };

            const handleRenameProfile = (id) => {
                const profile = profiles.find(p => p.id === id);
                if (!profile) return;
                const newName = window.prompt('请输入新的配置名称：', profile.name);
                if (newName && newName.trim()) {
                    const updatedProfiles = profiles.map(p =>
                        p.id === id ? { ...p, name: newName.trim() } : p
                    );
                    setProfiles(updatedProfiles);
                    alert('配置已成功重命名！');
                }
            };
            
            const handleExportProfile = () => {
                if (!activeProfile) return;
                downloadAsJson(activeProfile.settings, `${activeProfile.name.replace(/\s/g, '_')}.json`);
                showToast('当前配置已导出！');
            };

            const handleExportAllProfiles = () => {
                if (profiles.length === 0) {
                    showToast('没有可导出的配置。');
                    return;
                }
                profiles.forEach((profile, index) => {
                    setTimeout(() => {
                        downloadAsJson(profile.settings, `${profile.name.replace(/\s/g, '_')}.json`);
                    }, index * 200);
                });
                showToast(`${profiles.length} 个配置已开始导出！`);
            };

            useEffect(() => {
                if (!profiles || profiles.length === 0) {
                    setProfiles([DEFAULT_PROFILE]);
                }
                if (!profiles.find(p => p.id === activeProfileId)) {
                    setActiveProfileId(profiles[0]?.id || DEFAULT_PROFILE.id);
                }
            }, [profiles, activeProfileId, setProfiles, setActiveProfileId]);

            // This effect should run last to prevent initial animations.
            useEffect(() => {
                setIsMounted(true);
            }, []);

            const isPanelOpen = isSettingsOpen || isHistoryOpen || isTutorialOpen || isConsoleOpen;

            return (
                React.createElement('div', { className: `h-[100dvh] flex flex-col relative ${isMounted ? 'app-mounted' : ''}` },
                    toastMessage && React.createElement(Toast, { message: toastMessage }),
                    React.createElement(Header, { 
                        onHistoryClick: () => handleToggleHistory(), 
                        onSettingsClick: () => handleToggleSettings(),
                        onTutorialClick: () => handleToggleTutorial(),
                        onConsoleClick: () => handleToggleConsole(),
                        onNewChat: handleNewChat,
                        onToggleTheme: handleToggleTheme,
                        theme: theme,
                        activeProfileName: activeProfile.name
                    }),
                    React.createElement('main', { className: 'max-w-4xl mx-auto w-full flex flex-col relative z-10 flex-grow p-4 pb-0 min-h-0' },
                        React.createElement(MainContent, {
                            conversation: conversation,
                            isLoading: isLoading,
                            editingIndex: editingIndex,
                            editedContent: editedContent,
                            editedImage: editedImage,
                            setEditedContent: setEditedContent,
                            setEditedImage: setEditedImage,
                            onSaveEdit: handleSaveEdit,
                            onCancelEdit: handleCancelEdit,
                            onStartEdit: handleStartEdit,
                            onSuggestionClick: handleSuggestionClick,
                            isMounted: isMounted,
                            onRemoveEditedImage: handleRemoveEditedImage,
                            onPreviewImage: (url) => setPreviewImageUrl(url)
                        })
                    ),
                    React.createElement('div', { className: 'flex-shrink-0 bg-transparent z-10' },
                        React.createElement('div', { className: 'p-4 max-w-4xl mx-auto w-full' },
                            React.createElement('div', { className: 'ios-card p-4' },
                                React.createElement(ChatImagePreview, { 
                                    image: chatImage, 
                                    onRemove: () => setChatImage(null),
                                    onPreview: (url) => setPreviewImageUrl(url)
                                }),
                                React.createElement('div', { className: 'flex items-end gap-3' },
                                    React.createElement('textarea', {
                                        id: 'user-query',
                                        className: 'input-textarea w-full p-3 text-base resize-none max-h-40 h-11',
                                        placeholder: '继续输入以改进SQL，或开始新对话... (Shift+Enter 换行)',
                                        rows: 1,
                                        value: userQuery,
                                        onChange: (e) => {
                                            setUserQuery(e.target.value);
                                            e.target.style.height = 'auto';
                                            e.target.style.height = `${e.target.scrollHeight}px`;
                                        },
                                        onKeyDown: handleKeyDown,
                                        onPaste: handlePaste,
                                        disabled: isLoading || editingIndex !== null
                                    }),
                                    isLoading
                                        ? React.createElement('button', { onClick: handleStop, className: 'ios-button danger h-11 w-11 p-0 flex-shrink-0' }, React.createElement(StopIcon))
                                        : React.createElement('div', { className: 'input-area-buttons-container flex items-center gap-2 flex-shrink-0' },
                                            React.createElement('button', {
                                                onClick: () => imageInputRef.current?.click(),
                                                disabled: isLoading || editingIndex !== null,
                                                className: 'ios-button ios-button-secondary h-11 w-11 p-0',
                                                'aria-label': '上传图片'
                                            }, React.createElement('i', { className: 'fa-solid fa-image' })),
                                            React.createElement('input', {
                                                type: 'file',
                                                ref: imageInputRef,
                                                className: 'hidden',
                                                accept: 'image/*',
                                                onChange: handleImageUpload
                                            }),
                                            React.createElement('button', {
                                                onClick: handleRegenerateLastResponse,
                                                disabled: editingIndex !== null || !conversation.some(msg => msg.role === 'user'),
                                                className: 'ios-button ios-button-secondary h-11 w-11 p-0',
                                                'aria-label': '重新生成'
                                            }, React.createElement(RegenerateIcon)),
                                            React.createElement('button', {
                                                onClick: handleSendMessage,
                                                disabled: (!userQuery.trim() && !chatImage && !isLastMessageFromUser) || editingIndex !== null,
                                                className: 'ios-button h-11 w-11 p-0'
                                            }, React.createElement(SendIcon))
                                        )
                                )
                            )
                        )
                    ),
                    React.createElement(SettingsPanel, {
                        isOpen: isSettingsOpen,
                        onClose: () => handleToggleSettings(false),
                        activeProfile: activeProfile,
                        profiles: profiles,
                        onSave: handleSaveProfileSettings,
                        onSwitch: handleSwitchProfile,
                        onCreate: handleCreateProfile,
                        onDelete: handleDeleteProfile,
                        onRename: handleRenameProfile,
                        onExport: handleExportProfile,
                        onExportAll: handleExportAllProfiles,
                        onShowToast: showToast
                    }),
                    React.createElement(HistoryPanel, {
                        isOpen: isHistoryOpen,
                        onClose: () => handleToggleHistory(false),
                        history: history,
                        setHistory: setHistory,
                        onLoadConversation: handleLoadConversationFromHistory,
                        maxHistory: activeProfile.settings.maxHistory || 10
                    }),
                    React.createElement(ConsolePanel, {
                        isOpen: isConsoleOpen,
                        onClose: () => handleToggleConsole(false),
                        logs: consoleLogs,
                        onClearLogs: () => setConsoleLogs([])
                    }),
                    React.createElement(TutorialPanel, {
                        isOpen: isTutorialOpen,
                        onClose: () => handleToggleTutorial(false)
                    }),
                    previewImageUrl && React.createElement('div', {
                        onClick: (e) => setPreviewImageUrl(null),
                        className: 'fixed inset-0 bg-black/70 z-[101] flex items-center justify-center p-4 backdrop-blur-sm cursor-pointer'
                    }, 
                        React.createElement('img', { 
                            src: previewImageUrl, 
                            alt: 'Image preview', 
                            className: 'max-w-full max-h-full object-contain rounded-lg shadow-2xl cursor-default',
                            onClick: (e) => e.stopPropagation() // Prevent click on image from closing
                        })
                    ),
                    isPanelOpen && React.createElement('div', {
                        onClick: handleClosePanels,
                        className: 'fixed inset-0 bg-black/40 z-40 transition-opacity duration-300',
                        'aria-hidden': 'true'
                    })
                )
            );
        };
        
        // --- From index.tsx (App Entry Point) ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
            throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
            React.createElement(React.StrictMode, null, 
                React.createElement(App, null)
            )
        );
    </script>
</body>
</html>

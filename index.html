<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SQL 自动化编写助手</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20448%20512'%3E%3Cpath%20fill='%234a90e2'%20d='M448%2080v48c0%2044.2-100.3%2080-224%2080S0%20172.2%200%20128V80C0%2035.8%20100.3%200%20224%200S448%2035.8%20448%2080zM393.2%20214.7c20.8-7.4%2039.9-16.9%2054.8-28.6V288c0%2044.2-100.3%2080-224%2080S0%20332.2%200%20288V186.1c14.9%2011.8%2034%2021.2%2054.8%2028.6C99.7%20230.7%20159.5%20240%20224%20240s124.3-9.3%20169.2-25.3zM448%20368v48c0%2044.2-100.3%2080-224%2080S0%20460.2%200%20416V368c0-17.5%2013-32.9%2031.5-41.2C86.2%20344.3%20152.6%20352%20224%20352s137.8-7.7%20192.5-25.2c18.5%208.3%2031.5%2023.7%2031.5%2041.2z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #f8fafb;
            --card-bg: #ffffff;
            --text-primary: #1a1f36;
            --text-secondary: #6b7280;
            --accent-color: #4a90e2;
            --accent-light: #e3f2fd;
            --accent-dark: #2c5aa0;
            --border-color: #e5e7eb;
            --header-bg: rgba(255, 255, 255, 0.95);
            --info-bg: #e1f5fe;
            --info-border: #29b6f6;
            --danger-bg: #ff6b6b;
            --danger-hover-bg: #fa5252;
            --success-bg: #51cf66;
            --warning-bg: #ffd43b;
            --gradient-from: #4a90e2;
            --gradient-to: #64b5f6;
        }
        .dark {
            --bg-color: #0f1419;
            --card-bg: #1c2128;
            --text-primary: #e1e8ed;
            --text-secondary: #8899a6;
            --accent-color: #4a90e2;
            --accent-light: #1e3a5f;
            --accent-dark: #64b5f6;
            --border-color: #2f3336;
            --header-bg: rgba(15, 20, 25, 0.95);
            --info-bg: #0d47a1;
            --info-border: #29b6f6;
            --danger-bg: #e03131;
            --danger-hover-bg: #c92a2a;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            overscroll-behavior: none;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 400px;
            background: linear-gradient(135deg, var(--accent-light) 0%, transparent 50%);
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }
        .ios-header {
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .ios-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        .ios-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--gradient-from), var(--gradient-to));
            opacity: 0;
            transition: opacity 0.3s;
        }
        .ios-card:hover::before {
            opacity: 1;
        }
        .ios-button {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }
        .ios-button:hover {
            background: linear-gradient(135deg, var(--accent-dark), var(--accent-color));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        .dark .ios-button:hover { 
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }
        .ios-button:active {
            transform: scale(0.98);
        }
        .ios-button:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
            box-shadow: none;
        }
        .ios-button-secondary {
            background: var(--card-bg);
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
            box-shadow: none;
        }
        .dark .ios-button-secondary { 
            background-color: var(--card-bg); 
            color: var(--accent-color); 
            border-color: var(--accent-color); 
        }
        .ios-button-secondary:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
        }
        .ios-button-secondary:disabled {
            background-color: var(--card-bg);
            color: #9ca3af;
            border-color: #e5e7eb;
            opacity: 0.5;
        }
        .dark .ios-button-secondary:disabled { 
            color: #4b5563; 
            border-color: #374151; 
            background-color: var(--card-bg);
        }
        .ios-button.danger {
            background: linear-gradient(135deg, var(--danger-bg), var(--danger-hover-bg));
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }
        .ios-button.danger:hover {
            background: linear-gradient(135deg, var(--danger-hover-bg), var(--danger-bg));
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        .loader {
            border: 3px solid var(--accent-light);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .small-loader {
            display: inline-block;
            border: 2px solid var(--accent-light);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }
        .mono { 
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; 
        }
        .markdown-content {
            line-height: 1.6;
            font-size: 14px;
        }
        .markdown-content pre {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 12px;
            overflow-x: auto;
            font-size: 0.875em;
            line-height: 1.5;
            border: 1px solid rgba(74, 144, 226, 0.2);
        }
        .dark .markdown-content pre { 
            background: linear-gradient(135deg, #1a1f36, #0f1419); 
            color: #e1e8ed; 
        }
        .markdown-content code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        .markdown-content :not(pre) > code {
            background: var(--accent-light);
            color: var(--accent-dark);
            padding: 0.1em 0.3em;
            border-radius: 6px;
            font-weight: 500;
        }
        .dark .markdown-content :not(pre) > code { 
            background: var(--accent-light); 
            color: var(--accent-color);
        }
        .markdown-content ul, .markdown-content ol {
            padding-left: 1.75rem;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .markdown-content li {
            margin-top: 0.25rem;
        }
        .markdown-content p {
            margin-bottom: 1rem;
        }
        .markdown-content > :last-child {
            margin-bottom: 0;
        }
        .dark textarea, .dark select, .dark input { 
            background-color: #1c2128; 
            border-color: #374151; 
            color: var(--text-primary); 
        }
        .dark ::placeholder { color: #6b7280; }
        .dark .bg-gray-100 { background-color: #1c2128; }
        .dark .bg-gray-200 { background-color: #2f3336; }
        .dark .bg-gray-800 { background: linear-gradient(135deg, #1a1f36, #0f1419); }
        .dark .text-gray-500 { color: var(--text-secondary); }
        .dark .text-gray-600 { color: #8899a6; }
        .dark .text-gray-700 { color: #d1d5db; }
        .dark .text-gray-800 { color: var(--text-primary); }
        .dark .hover\:bg-gray-200:hover { background-color: #2f3336; }
        .dark .border-t { border-color: var(--border-color); }
        .dark .bg-white { background-color: var(--card-bg); }
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
            animation: toast-fade-in 0.3s ease-out, toast-fade-out 0.3s ease-in 2.7s;
            font-weight: 500;
        }
        .dark .toast-container { 
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark)); 
            color: white; 
        }
        @keyframes toast-fade-in {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes toast-fade-out {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }
        /* Message bubbles enhancement */
        .user-message {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-dark));
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }
        .assistant-message {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 18px 18px 18px 4px;
            border: 1px solid var(--border-color);
        }
        .dark .assistant-message {
            background: linear-gradient(135deg, #2f3336, #1c2128);
        }
        /* Input area enhancement */
        .input-textarea {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .input-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
        }
        /* Decorative elements */
        .decoration-dots {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, var(--accent-light) 2px, transparent 2px);
            background-size: 10px 10px;
            opacity: 0.3;
        }
        /* Panel slide animation */
        .slide-panel {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Button hover effects */
        .icon-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            border-radius: 12px;
        }
        .icon-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(74, 144, 226, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .icon-button:hover::before {
            width: 100%;
            height: 100%;
        }
        /* Code block enhancements */
        .code-block {
            position: relative;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 1px solid rgba(74, 144, 226, 0.2);
            border-radius: 12px;
        }
        .dark .code-block {
            background: linear-gradient(135deg, #1a1f36, #0f1419);
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
  }
}
</script>
</head>
<body class="antialiased">
    <div id="root"></div>
    <script type="module">
        import React, { useState, useCallback, useMemo, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        // All application code is consolidated below.
        // The original file structure has been flattened into this single script.

        // --- From types.ts ---
        // Interfaces are defined for TypeScript context but are not directly used in the compiled JS.

        // --- From constants.ts ---
        const LOCAL_STORAGE_PROFILES_KEY = 'sql_assistant_profiles_v2';
        const LOCAL_STORAGE_ACTIVE_PROFILE_ID_KEY = 'sql_assistant_active_profile_id_v2';
        const LOCAL_STORAGE_HISTORY_KEY = 'sql_assistant_history_v2';
        const LOCAL_STORAGE_THEME_KEY = 'sql_assistant_theme_v1';

        const DEFAULT_SETTINGS = {
            apiUrl: 'https://generativelanguage.googleapis.com/v1beta',
            apiKey: '',
            apiModel: 'gemini-2.5-flash',
            guidePrompt: `规则:
- 使用标准SQL语法
- 添加必要的注释
- 考虑查询性能`,
            dbSchema: `tables:
  employees:
    - id: int
    - name: varchar
    - department: varchar`,
            exampleChat: `- 用户: 查询所有员工
  SQL: SELECT * FROM employees
- 用户: 统计各部门人数
  SQL: SELECT department, COUNT(*) FROM employees GROUP BY department`,
            terminology: `术语:
  KPI: 关键绩效指标
  YoY: 同比增长
  活跃用户: 最近30天内有登录行为的用户`,
        };

        const DEFAULT_PROFILE = {
            id: 'default_profile_1',
            name: '默认配置 (Gemini)',
            settings: DEFAULT_SETTINGS,
        };

        // --- From utils/fileUtils.ts ---
        const downloadAsJson = (data, filename) => {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const readJsonFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const result = event.target?.result;
                        if (typeof result === 'string') {
                            resolve(JSON.parse(result));
                        } else {
                            reject(new Error('File content is not a string.'));
                        }
                    } catch (error) {
                        reject(new Error('Failed to parse JSON file.'));
                    }
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsText(file);
            });
        };

        // --- From services/apiService.ts ---
        const BUILT_IN_PROMPTS = {
            'guidePrompt': '以下是用户提供的自定义SQL生成规则和要求，请严格遵守：',
            'dbSchema': '以下是数据库的表结构定义，包含所有可用的表名和字段名：',
            'exampleChat': '以下是一些示例对话，展示了期望的查询模式和SQL生成风格：',
            'terminology': '以下是业务相关的专业术语定义，请在理解用户需求时参考：'
        };

        const generateSqlStream = async (chatHistory, settings, signal, onChunk, onComplete, onError) => {
            try {
                const isGemini = settings.apiUrl.includes('googleapis.com');
                let systemPromptBase;
                let requestUrl;
                let requestOptions;

                let customPrompts = "";
                (Object.keys(BUILT_IN_PROMPTS)).forEach(key => {
                    const content = settings[key]?.trim();
                    if (content) {
                        const title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        customPrompts += `\n\n--- ${title} ---\n`;
                        customPrompts += `${BUILT_IN_PROMPTS[key]}\n${content}`;
                    }
                });

                if (isGemini) {
                    systemPromptBase = "You are a professional SQL writing assistant. Please generate or refine SQL based on the user's request, considering the entire conversation history. Use the following information as your guide.\n\nFirst, provide a brief thinking process, which may include other code blocks. After that, provide the final, complete SQL code inside a markdown code block.";
                    
                    const systemPrompt = systemPromptBase + customPrompts;

                    requestUrl = `${settings.apiUrl}/models/${settings.apiModel}:streamGenerateContent?alt=sse&key=${settings.apiKey}`;
                    
                    const contents = chatHistory
                        .filter(msg => msg.content.trim() !== '')
                        .map(msg => ({
                            role: msg.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: msg.content }]
                        }));

                    const body = {
                        contents,
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { temperature: 0.2, topP: 0.95 }
                    };
                    
                    requestOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                        signal
                    };
                } else {
                    systemPromptBase = "You are a professional SQL writing assistant. Please generate or refine SQL based on the user's request, considering the entire conversation history. Use the following information as your guide.\n\nFirst, provide a brief thinking process, which may include other code blocks. After that, provide the final, complete SQL code inside a markdown code block.";
                    
                    const systemPrompt = systemPromptBase + customPrompts;
                    
                    if (settings.apiUrl.includes('/chat/completions')) {
                        requestUrl = settings.apiUrl;
                    } else {
                        const baseUrl = settings.apiUrl.endsWith('/') ? settings.apiUrl : settings.apiUrl + '/';
                        requestUrl = new URL('chat/completions', baseUrl).href;
                    }

                    const messages = [{ role: 'system', content: systemPrompt }, ...chatHistory];
                    
                    requestOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${settings.apiKey}`
                        },
                        body: JSON.stringify({
                            model: settings.apiModel,
                            messages: messages,
                            temperature: 0.1,
                            stream: true
                        }),
                        signal
                    };
                }
                
                const response = await fetch(requestUrl, requestOptions);

                if (!response.ok) {
                    let errData;
                    try {
                      errData = await response.json();
                    } catch(e) {
                      errData = { error: { message: await response.text() }};
                    }

                    let errMsg = errData.error?.message || `HTTP error! status: ${response.status}`;
                    if (response.status === 401) errMsg += '\n\n可能是API Key无效或已过期，请检查您的API Key。';
                    if (response.status === 429) errMsg += '\n\nAPI请求频率超限，请稍后再试。';
                    if (isGemini && response.status === 400) errMsg += '\n\n请求格式错误，请检查API URL和模型名称是否适用于Gemini。';
                    throw new Error(errMsg);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            if (!isGemini && jsonStr === '[DONE]') {
                                onComplete();
                                return;
                            }
                            try {
                                const chunk = JSON.parse(jsonStr);
                                let content = '';
                                if (isGemini) {
                                    content = chunk.candidates?.[0]?.content?.parts?.[0]?.text;
                                } else {
                                    content = chunk.choices?.[0]?.delta?.content;
                                }
                                if (content) {
                                    onChunk(content);
                                }
                            } catch (e) {
                                // Ignore JSON parsing errors for incomplete chunks
                            }
                        }
                    }
                }
                onComplete();
            } catch (error) {
                 if (error instanceof Error) {
                    onError(error);
                } else {
                    onError(new Error(String(error)));
                }
            }
        };

        const fetchModels = async (apiUrl, apiKey) => {
            if (!apiUrl.trim() || !apiKey.trim()) {
                throw new Error('API URL and Key cannot be empty.');
            }

            const isGemini = apiUrl.includes('googleapis.com');
            let modelsUrl;
            let requestOptions;

            if (isGemini) {
                modelsUrl = `${apiUrl}/models?key=${apiKey}`;
                requestOptions = { method: 'GET' };
            } else {
                if (!/^https?:\/\//.test(apiUrl)) {
                    throw new Error('API URL must start with http:// or https://');
                }
                if (apiUrl.includes('/chat/completions')) {
                    modelsUrl = apiUrl.replace('/chat/completions', '/models');
                } else {
                    modelsUrl = new URL('/v1/models', apiUrl).href;
                }
                requestOptions = {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                };
            }

            const response = await fetch(modelsUrl, requestOptions);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (isGemini) {
                if (data.models && Array.isArray(data.models)) {
                    return data.models.map(m => m.name.replace('models/', '')).filter(Boolean).sort();
                }
            } else {
                if (data.data && Array.isArray(data.data)) {
                    return data.data.map((m) => m.id).filter(Boolean).sort();
                }
            }

            throw new Error('Invalid response format from models endpoint.');
        };


        // --- From hooks/useLocalStorage.ts ---
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                if (typeof window === 'undefined') {
                    return initialValue;
                }
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            useEffect(() => {
                try {
                    if (typeof window !== 'undefined') {
                        window.localStorage.setItem(key, JSON.stringify(storedValue));
                    }
                } catch (error) {
                    console.error(error);
                }
            }, [key, storedValue]);

            return [storedValue, setStoredValue];
        }
        
        // --- From components/icons.tsx ---
        const HistoryIcon = () => (
            React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('path', { d: 'M3 3v5h5' }),
                React.createElement('path', { d: 'M3.05 13A9 9 0 1 0 8 3.46' }),
                React.createElement('path', { d: 'M12 7v5l4 2' })
            )
        );

        const SettingsIcon = () => (
            React.createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', width: '24', height: '24', viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('circle', { cx: '12', cy: '12', r: '3' }),
                React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z' })
            )
        );
        
        const SunIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}, React.createElement('circle',{cx:"12",cy:"12",r:"5"}), React.createElement('line',{x1:"12",y1:"1",x2:"12",y2:"3"}), React.createElement('line',{x1:"12",y1:"21",x2:"12",y2:"23"}), React.createElement('line',{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}), React.createElement('line',{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}), React.createElement('line',{x1:"1",y1:"12",x2:"3",y2:"12"}), React.createElement('line',{x1:"21",y1:"12",x2:"23",y2:"12"}), React.createElement('line',{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}), React.createElement('line',{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"}));
        const MoonIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round"}, React.createElement('path',{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"}));
        const InfoIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('circle',{cx:"12",cy:"12",r:"10"}), React.createElement('line',{x1:"12",y1:"16",x2:"12",y2:"12"}), React.createElement('line',{x1:"12",y1:"8",x2:"12.01",y2:"8"}));
        const SendIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: "h-5 w-5"}, React.createElement('line', { x1: "22", y1: "2", x2: "11", y2: "13" }), React.createElement('polygon', { points: "22 2 15 22 11 13 2 9 22 2" }));
        const StopIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "currentColor", className: "h-5 w-5 text-white" }, React.createElement('rect', { x: "6", y: "6", width: "12", height: "12", rx: "1" }));
        const EditIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "16", height: "16", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('path', { d: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"}));
        const RegenerateIcon = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: "h-5 w-5"}, React.createElement('path', { d: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" }), React.createElement('path', { d: "M21 3v5h-5" }), React.createElement('path', { d: "M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" }), React.createElement('path', { d: "M3 21v-5h5" }));

        // --- From components/Toast.tsx ---
        const Toast = ({ message }) => {
            return React.createElement('div', { className: 'toast-container' }, message);
        };

        // --- From components/Header.tsx ---
        const Header = ({ onHistoryClick, onSettingsClick, onTutorialClick, onToggleTheme, theme }) => {
            return (
                React.createElement('header', { className: 'ios-header sticky top-0 z-30 px-4 py-3' },
                    React.createElement('div', { className: 'lg:max-w-7xl mx-auto flex justify-between items-center' },
                        React.createElement('div', { className: 'flex-1 flex justify-start' },
                            React.createElement('button', { onClick: onHistoryClick, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '查看历史' },
                                React.createElement(HistoryIcon, null)
                            )
                        ),
                        React.createElement('h1', { className: 'text-xl font-bold text-center bg-gradient-to-r from-[var(--gradient-from)] to-[var(--gradient-to)] bg-clip-text text-transparent' }, 'SQL 自动化编写助手'),
                        React.createElement('div', { className: 'flex-1 flex justify-end items-center gap-1' },
                           React.createElement('button', { onClick: onToggleTheme, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '切换主题' },
                                theme === 'light' ? React.createElement(MoonIcon, null) : React.createElement(SunIcon, null)
                            ),
                            React.createElement('button', { onClick: onTutorialClick, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '查看教程' },
                                React.createElement(InfoIcon, null)
                            ),
                            React.createElement('button', { onClick: onSettingsClick, className: 'icon-button p-2 hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '打开设置' },
                                React.createElement(SettingsIcon, null)
                            )
                        )
                    )
                )
            );
        };

        // --- From components/MainContent.tsx ---
        const MainContent = ({ userQuery, setUserQuery, conversation, setConversation, activeSettings, onNewChat, onSettingsClick }) => {
            const [isLoading, setIsLoading] = useState(false);
            const [copySuccessIndex, setCopySuccessIndex] = useState(-1);
            const [editingIndex, setEditingIndex] = useState(null);
            const [editedContent, setEditedContent] = useState('');
            const abortControllerRef = useRef(null);
            const chatContainerRef = useRef(null);

            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [conversation, isLoading, editingIndex]);

            const runGeneration = async (chatHistoryForApi, isRegeneration = false, regenerationIndex = -1) => {
                if (!activeSettings.apiUrl || !activeSettings.apiKey) {
                    alert('请先在设置中配置API！');
                    onSettingsClick();
                    return;
                }
                
                setIsLoading(true);
                abortControllerRef.current = new AbortController();

                if (!isRegeneration) {
                    setConversation(prev => [...prev, { role: 'assistant', content: '', isStreaming: true }]);
                } else {
                    setConversation(prev => [...prev.slice(0, regenerationIndex + 1), { role: 'assistant', content: '', isStreaming: true }]);
                }
                
                const onChunk = (chunk) => {
                    setConversation(prev => {
                        const lastMessage = prev[prev.length - 1];
                        if (lastMessage && lastMessage.role === 'assistant') {
                            const updatedLastMessage = { ...lastMessage, content: lastMessage.content + chunk };
                            return [...prev.slice(0, -1), updatedLastMessage];
                        }
                        return prev;
                    });
                };
                
                const onComplete = () => {
                    setConversation(prev => {
                        const lastMessage = prev[prev.length - 1];
                        if (lastMessage && lastMessage.role === 'assistant') {
                            const rawContent = lastMessage.content.trim();
                            const codeBlockRegex = /```(?:[a-zA-Z]*)?\n?([\s\S]+?)```/g;
                            const matches = [...rawContent.matchAll(codeBlockRegex)];

                            let thinking = rawContent;
                            let sql = '';

                            if (matches.length > 0) {
                                const lastMatch = matches[matches.length - 1];
                                sql = lastMatch[1].trim();
                                thinking = rawContent.substring(0, lastMatch.index).trim();
                            } else {
                                sql = rawContent; 
                                thinking = '';
                            }

                            const updatedLastMessage = { 
                                ...lastMessage, 
                                content: rawContent, 
                                thinking: thinking,
                                sql: sql,
                                isStreaming: false 
                            };
                            return [...prev.slice(0, -1), updatedLastMessage];
                        }
                        return prev;
                    });
                    setIsLoading(false);
                    abortControllerRef.current = null;
                };

                const onError = (error) => {
                    setConversation(prev => {
                        const lastMessage = prev[prev.length - 1];
                        const isAbort = error instanceof Error && error.name === 'AbortError';
                        const content = isAbort ? '-- 生成已手动停止 --' : `-- 生成 SQL 时出错 --\n${error.message}`;
                
                        if (lastMessage && lastMessage.role === 'assistant') {
                            const updatedLastMessage = { ...lastMessage, sql: lastMessage.sql ? lastMessage.sql + `\n\n${content}` : content, isError: true, isStreaming: false };
                            return [...prev.slice(0, -1), updatedLastMessage];
                        }
                        return [...prev, { role: 'assistant', sql: content, isError: true, isStreaming: false }];
                    });
                    setIsLoading(false);
                    abortControllerRef.current = null;
                };

                await generateSqlStream(
                    chatHistoryForApi,
                    activeSettings,
                    abortControllerRef.current.signal,
                    onChunk,
                    onComplete,
                    onError
                );
            };

            const handleSendMessage = useCallback(async () => {
                const trimmedQuery = userQuery.trim();
                if (!trimmedQuery) {
                    alert('请输入您的需求！');
                    return;
                }
                const userMessage = { role: 'user', content: trimmedQuery };
                const newConversation = [...conversation, userMessage];
                setConversation(newConversation);
                setUserQuery('');
                await runGeneration(newConversation, false);
            }, [userQuery, conversation, activeSettings, onSettingsClick, setConversation, setUserQuery]);

            const handleSaveEdit = useCallback(() => {
                if (editingIndex === null) return;

                const trimmedContent = editedContent.trim();
                if (!trimmedContent) {
                    alert('内容不能为空！');
                    return;
                }
                
                const updatedConversation = [...conversation];
                updatedConversation[editingIndex] = { ...updatedConversation[editingIndex], content: trimmedContent };
                
                setConversation(updatedConversation);
                setEditingIndex(null);
                setEditedContent('');
            }, [editingIndex, editedContent, conversation, setConversation]);
            
            const handleRegenerateLastResponse = useCallback(async () => {
                let lastUserMessageIndex = -1;
                for (let i = conversation.length - 1; i >= 0; i--) {
                    if (conversation[i].role === 'user') {
                        lastUserMessageIndex = i;
                        break;
                    }
                }

                if (lastUserMessageIndex === -1) return;
                
                const chatHistoryForApi = conversation.slice(0, lastUserMessageIndex + 1);
                setConversation(chatHistoryForApi);
                await runGeneration(chatHistoryForApi, true, lastUserMessageIndex);

            }, [conversation, activeSettings, setConversation]);

            const handleStop = () => {
                if (abortControllerRef.current) {
                    abortControllerRef.current.abort();
                }
            };

            const handleCopy = (sql, index) => {
                if (!sql) return;
                navigator.clipboard.writeText(sql).then(() => {
                    setCopySuccessIndex(index);
                    setTimeout(() => setCopySuccessIndex(-1), 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('复制失败，请手动选择复制');
                });
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };
            
            const startEditing = (index, content) => {
                setEditingIndex(index);
                setEditedContent(content);
            };

            const cancelEditing = () => {
                setEditingIndex(null);
                setEditedContent('');
            };

            return React.createElement(React.Fragment, null,
                React.createElement('div', { className: 'flex justify-between items-center mb-4' },
                    React.createElement('h2', { className: 'text-lg font-semibold flex items-center gap-2' }, 
                        React.createElement('span', { className: 'w-3 h-3 bg-gradient-to-r from-[var(--gradient-from)] to-[var(--gradient-to)] rounded-full' }),
                        '对话'
                    ),
                    React.createElement('button', { onClick: onNewChat, className: 'ios-button ios-button-secondary py-2 px-4 text-sm' }, '开启新对话')
                ),
                React.createElement('div', { className: 'ios-card flex flex-col h-[calc(100vh-280px)] min-h-[300px] max-h-[600px]' },
                    React.createElement('div', { className: 'decoration-dots top-2 right-2' }),
                    React.createElement('div', { ref: chatContainerRef, className: 'flex-grow overflow-y-auto p-5 space-y-6' },
                        conversation.length === 0 ? (
                            React.createElement('div', { className: 'text-center text-gray-500 flex flex-col justify-center items-center h-full' },
                                React.createElement('div', { className: 'w-16 h-16 bg-gradient-to-br from-[var(--gradient-from)] to-[var(--gradient-to)] rounded-full mb-4 opacity-20' }),
                                React.createElement('h3', { className: 'text-xl font-semibold mb-2' }, 'SQL 自动化编写助手'),
                                React.createElement('p', null, '输入您的需求开始生成SQL。'),
                                React.createElement('p', null, '您可以持续对话，对生成的SQL进行修改和完善。')
                            )
                        ) : (
                            conversation.map((msg, index) =>
                                msg.role === 'user' ? (
                                    React.createElement('div', { key: index, className: 'flex justify-end group' },
                                        editingIndex === index ? 
                                        React.createElement('div', { className: 'user-message p-3 w-full max-w-[85%]' },
                                            React.createElement('textarea', {
                                                value: editedContent,
                                                onChange: e => setEditedContent(e.target.value),
                                                className: 'w-full bg-white/20 rounded-md p-2 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50',
                                                rows: 3
                                            }),
                                            React.createElement('div', { className: 'flex justify-end gap-2 mt-2' },
                                                React.createElement('button', { onClick: cancelEditing, className: 'ios-button ios-button-secondary text-xs px-3 py-1 bg-white/20 text-white border-white/30 hover:bg-white/30' }, '取消'),
                                                React.createElement('button', { onClick: handleSaveEdit, className: 'ios-button text-xs px-3 py-1 bg-white text-[var(--accent-color)] hover:bg-gray-100' }, '保存')
                                            )
                                        ) :
                                        React.createElement('div', { className: 'flex items-center gap-2' },
                                            React.createElement('button', { onClick: () => startEditing(index, msg.content), disabled: isLoading, className: 'opacity-0 group-hover:opacity-100 transition-opacity p-1 text-gray-500 hover:text-[var(--accent-color)] disabled:opacity-20', 'aria-label': '编辑' },
                                                React.createElement(EditIcon, null)
                                            ),
                                            React.createElement('div', { className: 'user-message p-3 max-w-[85%] whitespace-pre-wrap' }, msg.content)
                                        )
                                    )
                                ) : (
                                    React.createElement('div', { key: index, className: 'flex justify-start' },
                                        React.createElement('div', { className: `assistant-message p-3 w-full ${msg.isError ? 'border-l-4 border-[var(--danger-bg)]' : ''}` },
                                            React.createElement('div', { className: 'flex justify-between items-center mb-2' },
                                                React.createElement('span', { className: 'text-sm font-semibold text-[var(--accent-color)]' }, '助手'),
                                                !msg.isError && !msg.isStreaming && React.createElement('button', { onClick: () => handleCopy(msg.sql, index), className: 'ios-button ios-button-secondary text-xs py-1 px-3' }, 
                                                  copySuccessIndex === index ? '已复制' : '复制'
                                                )
                                            ),
                                            (msg.thinking && !msg.isStreaming) && React.createElement('details', { className: 'mb-2' },
                                                React.createElement('summary', { className: 'text-xs text-gray-600 cursor-pointer select-none' }, '查看思考过程'),
                                                React.createElement('div', {
                                                    className: 'markdown-content mt-1 p-2 bg-gray-200 text-gray-700 rounded',
                                                    dangerouslySetInnerHTML: { __html: window.marked ? window.marked.parse(msg.thinking || '') : msg.thinking }
                                                })
                                            ),
                                            React.createElement('pre', { className: 'code-block p-3 overflow-x-auto text-sm mono whitespace-pre-wrap text-white' }, 
                                                React.createElement('code', null, 
                                                    msg.isStreaming ? msg.content : msg.sql,
                                                    msg.isStreaming && React.createElement('span', { className: 'inline-block w-2 h-4 bg-[var(--accent-color)] animate-pulse ml-1 align-middle' })
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        ),
                        isLoading && conversation[conversation.length - 1]?.isStreaming !== true && React.createElement('div', { className: 'flex items-center gap-3 p-4' },
                            React.createElement('div', { className: 'small-loader' }),
                            React.createElement('p', { className: 'text-gray-600 animate-pulse' }, '助手正在思考...')
                        )
                    )
                ),
                React.createElement('div', { className: 'ios-card p-4 mt-4' },
                    React.createElement('div', { className: 'flex items-end gap-3' },
                        React.createElement('textarea', {
                            id: 'user-query',
                            className: 'input-textarea w-full p-3 text-base resize-none max-h-40 overflow-y-auto',
                            placeholder: '继续输入以改进SQL，或开始新对话... (Shift+Enter 换行)',
                            value: userQuery,
                            onChange: (e) => {
                                setUserQuery(e.target.value);
                                e.target.style.height = 'auto';
                                e.target.style.height = `${e.target.scrollHeight}px`;
                            },
                            onKeyDown: handleKeyDown,
                            disabled: isLoading || editingIndex !== null,
                            rows: 1
                        }),
                        isLoading
                            ? React.createElement('button', { onClick: handleStop, className: 'ios-button danger p-3 flex items-center justify-center flex-shrink-0' }, React.createElement(StopIcon))
                            : React.createElement('div', { className: 'flex items-center gap-2 flex-shrink-0' },
                                React.createElement('button', {
                                    onClick: handleRegenerateLastResponse,
                                    disabled: editingIndex !== null || !conversation.some(msg => msg.role === 'assistant'),
                                    className: 'ios-button ios-button-secondary p-3 flex items-center justify-center',
                                    'aria-label': '重新生成'
                                }, React.createElement(RegenerateIcon)),
                                React.createElement('button', { onClick: handleSendMessage, disabled: !userQuery.trim() || editingIndex !== null, className: 'ios-button p-3 flex items-center justify-center' }, React.createElement(SendIcon))
                            )
                    )
                )
            );
        };
        
        // --- From components/SettingsPanel.tsx ---
        const promptFields = [
            { key: 'guidePrompt', label: '1. 引导提示 (Guide Prompt)', description: 'AI将理解这是您提供的自定义SQL生成规则和要求', placeholder: '输入您的自定义引导提示...\n例如：\n规则:\n - 使用标准SQL语法...' },
            { key: 'dbSchema', label: '2. 数据库表结构 (DB Schema)', description: 'AI将理解这是数据库的表名和字段名定义', placeholder: '输入表名和字段名...\n例如：\ntables:\n  employees:\n    - id: int...' },
            { key: 'exampleChat', label: '3. 示例对话 (Example Chat)', description: 'AI将参考这些示例来理解您的查询模式', placeholder: '输入示例对话...\n例如：\n- 用户: 查询所有员工\n  SQL: SELECT * FROM employees' },
            { key: 'terminology', label: '4. 行业术语定义 (Terminology)', description: 'AI将根据这些定义理解特定的业务术语', placeholder: '输入行业术语及其定义...\n例如：\n术语:\n  KPI: 关键绩效指标' },
        ];

        const SettingsPanel = ({ isOpen, onClose, activeProfile, profiles, onSave, onSwitch, onCreate, onDelete, onRename, onExport, onClearAll, onShowToast }) => {
            const [currentSettings, setCurrentSettings] = useState(activeProfile.settings);
            const [newProfileName, setNewProfileName] = useState('');
            const importFileRef = useRef(null);
            const [availableModels, setAvailableModels] = useState([]);
            const [isFetchingModels, setIsFetchingModels] = useState(false);

            useEffect(() => {
                setCurrentSettings(activeProfile.settings);
                setAvailableModels(activeProfile.settings.apiModel ? [activeProfile.settings.apiModel] : []);
            }, [activeProfile]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setCurrentSettings(prev => ({ ...prev, [name]: value }));
            };

            const handleFileChange = async (e, key) => {
                const file = e.target.files?.[0];
                if (file) {
                    const content = await file.text();
                    setCurrentSettings(prev => ({...prev, [key]: content}));
                }
            };
            
            const handleSaveNewProfile = () => {
                if (!newProfileName.trim()) {
                    alert('请输入新配置的名称。');
                    return;
                }
                onCreate(newProfileName.trim(), DEFAULT_SETTINGS);
                setNewProfileName('');
            };

            const handleImport = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                try {
                    const importedSettings = await readJsonFile(file);
                    const name = prompt('请输入新配置的名称：', file.name.replace('.json', ''));
                    if (name) {
                        const newProfile = onCreate(name, importedSettings);
                        onSwitch(newProfile.id);
                    }
                } catch (error) {
                    alert('导入失败，请确保文件是有效的JSON配置文件。');
                }
                e.target.value = ''; // Reset file input
            };

            const handleFetchModels = async () => {
                setIsFetchingModels(true);
                try {
                    const models = await fetchModels(currentSettings.apiUrl, currentSettings.apiKey);
                    setAvailableModels(models);
                     if (models.length > 0) {
                        onShowToast('模型列表获取成功！');
                        if (!models.includes(currentSettings.apiModel)) {
                            setCurrentSettings(prev => ({ ...prev, apiModel: models[0] }));
                        }
                    } else {
                        onShowToast('获取成功，但未找到可用模型。');
                    }
                } catch (error) {
                    alert(`获取模型列表失败: ${error instanceof Error ? error.message : '未知错误'}`);
                    setAvailableModels([]);
                } finally {
                    setIsFetchingModels(false);
                }
            };

            return (
                React.createElement('div', { className: `slide-panel fixed top-0 w-full max-w-md h-full bg-[var(--bg-color)] shadow-xl z-50 flex flex-col ${isOpen ? 'right-0' : '-right-full'}`},
                    React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                        React.createElement('div', { className: 'flex justify-between items-center' },
                            React.createElement('h2', { className: 'text-xl font-bold' }, '设置'),
                            React.createElement('button', { onClick: onClose, className: 'icon-button p-2 text-2xl font-bold hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭设置' }, '×')
                        )
                    ),
                    React.createElement('div', { className: 'p-5 overflow-y-auto flex-grow' },
                        React.createElement('div', { className: 'space-y-6' },
                            React.createElement('div', { className: 'ios-card p-5' },
                                React.createElement('h3', { className: 'text-lg font-semibold mb-3' }, '配置管理'),
                                React.createElement('div', { className: 'space-y-3' },
                                    React.createElement('div', null,
                                        React.createElement('label', { htmlFor: 'profile-select', className: 'block text-sm font-medium text-gray-700 mb-1' }, '当前配置'),
                                        React.createElement('select', { id: 'profile-select', value: activeProfile.id, onChange: (e) => onSwitch(e.target.value), className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base' },
                                            profiles.map(p => React.createElement('option', { key: p.id, value: p.id }, p.name))
                                        )
                                    ),
                                    React.createElement('div', { className: 'flex gap-2' },
                                        React.createElement('input', { type: 'text', value: newProfileName, onChange: (e) => setNewProfileName(e.target.value), placeholder: '新配置名称', className: 'flex-grow p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base' }),
                                        React.createElement('button', { onClick: handleSaveNewProfile, className: 'ios-button ios-button-secondary text-sm px-3 py-1' }, '创建')
                                    ),
                                    React.createElement('div', { className: 'grid grid-cols-2 gap-2'},
                                        React.createElement('button', { onClick: () => onRename(activeProfile.id), className: 'ios-button ios-button-secondary text-sm w-full py-2' }, '重命名当前配置'),
                                        React.createElement('button', { onClick: () => onDelete(activeProfile.id), className: 'ios-button danger text-sm w-full py-2' }, '删除当前配置')
                                    )
                                )
                            ),
                            ...promptFields.map(({key, label, description, placeholder}) => (
                                React.createElement('div', { key: key, className: 'ios-card p-5' },
                                    React.createElement('label', { htmlFor: key, className: 'block text-lg font-semibold mb-3' }, label),
                                    React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, description),
                                    React.createElement('textarea', { id: key, name: key, value: currentSettings[key], onChange: handleChange, className: 'w-full border-2 border-[var(--border-color)] rounded-lg p-3 text-base resize-vertical min-h-[120px] bg-[var(--card-bg)] focus:outline-none focus:border-[var(--accent-color)] focus:ring-2 focus:ring-[var(--accent-color)]/20', placeholder: placeholder }),
                                    React.createElement('input', { type: 'file', id: `${key}-upload`, className: 'hidden', accept: '.txt,.md,.yaml,.yml,.sql', onChange: (e) => handleFileChange(e, key) }),
                                    React.createElement('button', { onClick: () => document.getElementById(`${key}-upload`)?.click(), className: 'ios-button ios-button-secondary mt-3 w-full' }, '上传文件')
                                )
                            )),
                            React.createElement('hr', { className: 'border-[var(--border-color)]' }),
                            React.createElement('h3', { className: 'text-lg font-semibold' }, 'API 配置'),
                            React.createElement('div', null,
                                React.createElement('label', { htmlFor: 'apiUrl', className: 'block text-sm font-medium text-gray-700 mb-1' }, 'API 链接'),
                                React.createElement('input', { type: 'url', id: 'apiUrl', name: 'apiUrl', value: currentSettings.apiUrl, onChange: handleChange, className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base', placeholder: 'https://generativelanguage.googleapis.com/v1beta' })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { htmlFor: 'apiKey', className: 'block text-sm font-medium text-gray-700 mb-1' }, 'API Key'),
                                React.createElement('input', { type: 'password', id: 'apiKey', name: 'apiKey', value: currentSettings.apiKey, onChange: handleChange, className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base', placeholder: 'Enter your API Key' })
                            ),
                            React.createElement('button', { onClick: handleFetchModels, disabled: isFetchingModels || !currentSettings.apiUrl || !currentSettings.apiKey, className: 'ios-button ios-button-secondary w-full mt-3 flex items-center justify-center gap-2' },
                                React.createElement('span', null, isFetchingModels ? '获取中...' : '获取可用模型'),
                                isFetchingModels && React.createElement('div', { className: 'small-loader' })
                            ),
                            availableModels.length > 0 && (
                                React.createElement('div', null,
                                    React.createElement('label', { htmlFor: 'apiModel', className: 'block text-sm font-medium text-gray-700 mb-1' }, '选择模型'),
                                    React.createElement('select', { id: 'apiModel', name: 'apiModel', value: currentSettings.apiModel, onChange: handleChange, className: 'w-full p-2 border-2 border-[var(--border-color)] rounded-lg bg-[var(--card-bg)] text-base' },
                                        React.createElement('option', { value: '' }, '请选择模型'),
                                        availableModels.map(m => React.createElement('option', { key: m, value: m }, m))
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: 'p-4 border-t border-[var(--border-color)] flex-shrink-0 bg-[var(--card-bg)]' },
                        React.createElement('div', { className: 'mx-auto grid gap-2' },
                            React.createElement('button', { onClick: () => onSave(currentSettings), className: 'ios-button w-full' }, '保存设置'),
                            React.createElement('button', { onClick: onClearAll, className: 'ios-button danger w-full' }, '清除所有数据'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                React.createElement('button', { onClick: onExport, className: 'ios-button ios-button-secondary w-full' }, '导出设置'),
                                React.createElement('button', { onClick: () => importFileRef.current?.click(), className: 'ios-button ios-button-secondary w-full' }, '导入设置'),
                                React.createElement('input', { type: 'file', ref: importFileRef, onChange: handleImport, className: 'hidden', accept: '.json' })
                            )
                        )
                    )
                )
            );
        };
        
        // --- From components/HistoryPanel.tsx ---
        const HistoryPanel = ({ isOpen, onClose, history, setHistory, onLoadConversation }) => {
            const importFileRef = useRef(null);

            const clearHistory = () => {
                if (window.confirm('确定清空所有历史记录吗？')) {
                    setHistory([]);
                }
            };
            
            const deleteItem = (timestamp) => {
                if (window.confirm('确定删除这条历史记录吗？')) {
                    setHistory(prev => prev.filter(item => item.time !== timestamp));
                }
            };
            
            const copySql = (conversation) => {
                const finalSql = [...conversation].reverse().find(m => m.role === 'assistant' && !m.isError)?.sql;
                if (finalSql) {
                    navigator.clipboard.writeText(finalSql).then(() => alert('最终的 SQL 已复制到剪贴板')).catch(() => alert('复制失败'));
                } else {
                    alert('此对话中没有找到有效的 SQL。');
                }
            };

            const loadConversation = (conversation) => {
                onLoadConversation(conversation);
                onClose();
            };
            
            const handleExport = () => {
                if (history.length === 0) {
                    alert('没有历史记录可以导出。');
                    return;
                }
                downloadAsJson(history, 'sql_assistant_history.json');
            };

            const handleImport = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                if (!window.confirm('这将替换您当前的历史记录。要继续吗？')) {
                    e.target.value = '';
                    return;
                }

                try {
                    const importedHistory = await readJsonFile(file);
                    if (Array.isArray(importedHistory) && importedHistory.every(item => 'conversation' in item && 'time' in item)) {
                        setHistory(importedHistory.slice(0, 10));
                        alert('历史记录导入成功！');
                    } else {
                        throw new Error('文件内容不是有效的历史记录格式。');
                    }
                } catch (error) {
                    const message = error instanceof Error ? error.message : '未知错误';
                    alert(`导入失败: ${message}`);
                } finally {
                    e.target.value = '';
                }
            };

            return (
                React.createElement('aside', { className: `slide-panel fixed top-0 w-full max-w-lg h-full bg-[var(--bg-color)] shadow-xl z-50 flex flex-col ${isOpen ? 'left-0' : '-left-full'}` },
                    React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                        React.createElement('div', { className: 'flex justify-between items-center' },
                            React.createElement('h2', { className: 'text-xl font-bold' }, '历史记录 (最近10条)'),
                            React.createElement('button', { onClick: onClose, className: 'icon-button p-2 text-2xl font-bold hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭历史' }, '×')
                        )
                    ),
                    React.createElement('div', { className: 'p-5 overflow-y-auto flex-grow' },
                        history.length === 0 ? (
                            React.createElement('p', { className: 'text-sm text-gray-500' }, '暂无历史记录。')
                        ) : (
                            history.map((h, idx) => {
                                const initialRequest = h.conversation.find(m => m.role === 'user')?.content || '无初始请求';
                                const finalSql = [...h.conversation].reverse().find(m => m.role === 'assistant' && !m.isError)?.sql || '无有效 SQL';
                                return React.createElement('div', { key: h.time, className: 'ios-card p-4 mb-3' },
                                    React.createElement('div', { className: 'flex items-start justify-between gap-3' },
                                        React.createElement('div', { className: 'flex-1' },
                                            React.createElement('div', { className: 'text-xs text-[var(--accent-color)]' }, `#${history.length - idx} · ${new Date(h.time).toLocaleString()}`),
                                            React.createElement('div', { className: 'mt-1 text-sm' }, React.createElement('span', {className: 'font-semibold'}, '初始需求：'), initialRequest.slice(0, 200) + (initialRequest.length > 200 ? '...' : ''))
                                        ),
                                        React.createElement('button', { onClick: () => loadConversation(h.conversation), className: 'ios-button ios-button-secondary text-sm px-4 whitespace-nowrap' }, '加载')
                                    ),
                                    React.createElement('details', { className: 'mt-2' },
                                        React.createElement('summary', { className: 'text-sm text-gray-600 cursor-pointer' }, '查看最终 SQL'),
                                        React.createElement('pre', { className: 'mt-2 p-3 code-block text-white rounded-lg overflow-auto mono text-xs' }, finalSql)
                                    ),
                                    React.createElement('div', { className: 'mt-3 flex gap-2' },
                                        React.createElement('button', { onClick: () => copySql(h.conversation), className: 'ios-button ios-button-secondary text-xs px-2 py-1' }, '复制SQL'),
                                        React.createElement('button', { onClick: () => deleteItem(h.time), className: 'ios-button danger text-xs px-2 py-1' }, '删除')
                                    )
                                );
                            })
                        )
                    ),
                    React.createElement('div', { className: 'p-4 border-t border-[var(--border-color)] flex-shrink-0 bg-[var(--card-bg)]' },
                        React.createElement('div', { className: 'mx-auto grid gap-2' },
                            React.createElement('button', { onClick: clearHistory, className: 'ios-button danger w-full', disabled: history.length === 0 }, '清空历史'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                React.createElement('button', { onClick: handleExport, className: 'ios-button ios-button-secondary w-full', disabled: history.length === 0 }, '导出历史'),
                                React.createElement('button', { onClick: () => importFileRef.current?.click(), className: 'ios-button ios-button-secondary w-full' }, '导入历史')
                            ),
                            React.createElement('input', { type: 'file', ref: importFileRef, onChange: handleImport, className: 'hidden', accept: '.json' })
                        )
                    )
                )
            );
        };
        
        // --- From components/TutorialPanel.tsx ---
        const TutorialPanel = ({ isOpen, onClose }) => {
            const Section = ({ title, children }) => React.createElement('div', { className: 'ios-card p-5' },
                React.createElement('h3', { className: 'text-lg font-semibold mb-3 text-[var(--accent-color)]' }, title),
                React.createElement('div', { className: 'text-sm text-gray-600 space-y-2' }, children)
            );

            const Tip = ({ title, children }) => React.createElement('div', { className: 'mt-4 p-3 bg-[var(--info-bg)] border-l-4 border-[var(--info-border)] rounded-r-lg' },
                React.createElement('p', { className: 'font-semibold text-[var(--info-border)]' }, title),
                React.createElement('p', { className: 'mt-1' }, children)
            );

            return React.createElement('div', { className: `slide-panel fixed top-0 w-full max-w-md h-full bg-[var(--bg-color)] shadow-xl z-50 flex flex-col ${isOpen ? 'right-0' : '-right-full'}`},
                React.createElement('header', { className: 'ios-header p-4 flex-shrink-0' },
                    React.createElement('div', { className: 'flex justify-between items-center' },
                        React.createElement('h2', { className: 'text-xl font-bold' }, '教程与提示'),
                        React.createElement('button', { onClick: onClose, className: 'icon-button p-2 text-2xl font-bold hover:bg-gray-200 rounded-lg transition-colors', 'aria-label': '关闭教程' }, '×')
                    )
                ),
                React.createElement('div', { className: 'p-5 overflow-y-auto flex-grow space-y-6' },
                    React.createElement(Section, { title: '基础功能' },
                        React.createElement('p', null, '欢迎使用 SQL 自动化编写助手！本工具旨在帮助您通过自然语言快速生成和优化 SQL 查询。'),
                        React.createElement('ul', { className: 'list-disc list-inside space-y-1' },
                            React.createElement('li', null, React.createElement('strong', null, '对话式生成: '), '在下方的输入框中输入您的数据需求，点击发送即可生成 SQL。'),
                            React.createElement('li', null, React.createElement('strong', null, '持续优化: '), '您可以继续输入指令，对已生成的 SQL 进行修改，例如 "添加 xx 条件" 或 "按 xx 排序"。'),
                            React.createElement('li', null, React.createElement('strong', null, '编辑与重生成: '), '将鼠标悬停在您的消息上可进行编辑。您也可以点击 "重新生成" 按钮让 AI 重新回答最后一个问题。'),
                            React.createElement('li', null, React.createElement('strong', null, '新对话: '), '点击 "开启新对话" 会将当前对话存入历史记录，并开始一个全新的会话。')
                        )
                    ),
                    React.createElement(Section, { title: '配置管理 (设置面板)' },
                         React.createElement('ul', { className: 'list-disc list-inside space-y-1' },
                            React.createElement('li', null, React.createElement('strong', null, '多套配置: '), '您可以创建多套配置方案，以适应不同的数据库或项目需求。'),
                            React.createElement('li', null, React.createElement('strong', null, '自定义 Prompt: '), '通过修改引导提示、数据库结构等信息，您可以定制 AI 的行为，使其生成更符合您需求的 SQL。'),
                            React.createElement('li', null, React.createElement('strong', null, 'API 设置: '), '在这里配置您的 API 服务地址和 Key。点击 "获取可用模型" 将自动拉取并填充模型列表。')
                        ),
                        React.createElement(Tip, { title: '高级提示：使用 YAML 格式' },
                            '在 "数据库表结构" 或 "行业术语定义" 等字段中，使用清晰的 YAML 格式可以让 AI 更准确地理解和记忆您的上下文信息，从而提高生成质量。'
                        )
                    ),
                    React.createElement(Section, { title: 'API URL 支持格式' },
                        React.createElement('p', null, '本工具支持多种 API 格式：'),
                        React.createElement('ul', { className: 'list-disc list-inside space-y-1' },
                            React.createElement('li', null, React.createElement('strong', null, 'Google Gemini: '), '官方标准链接，例如 ', React.createElement('code', {className: 'text-xs bg-[var(--accent-light)] text-[var(--accent-dark)] p-1 rounded'}, 'https://generativelanguage.googleapis.com/v1beta')),
                            React.createElement('li', null, React.createElement('strong', null, 'OpenAI 兼容格式: '), '任何兼容 OpenAI 聊天接口的 API。程序会自动在链接后拼接 ', React.createElement('code', {className: 'text-xs bg-[var(--accent-light)] text-[var(--accent-dark)] p-1 rounded'}, '/chat/completions'), '。请提供基础 URL，例如 ', React.createElement('code', {className: 'text-xs bg-[var(--accent-light)] text-[var(--accent-dark)] p-1 rounded'}, 'https://api.example.com/v1'))
                        )
                    )
                )
            );
        };

        // --- From App.tsx ---
        const App = () => {
            const [isSettingsOpen, setSettingsOpen] = useState(false);
            const [isHistoryOpen, setHistoryOpen] = useState(false);
            const [isTutorialOpen, setTutorialOpen] = useState(false);
            const [theme, setTheme] = useLocalStorage(LOCAL_STORAGE_THEME_KEY, 'light');
            const [toastMessage, setToastMessage] = useState(null);
            
            const [profiles, setProfiles] = useLocalStorage(LOCAL_STORAGE_PROFILES_KEY, [DEFAULT_PROFILE]);
            const [activeProfileId, setActiveProfileId] = useLocalStorage(LOCAL_STORAGE_ACTIVE_PROFILE_ID_KEY, DEFAULT_PROFILE.id);
            const [history, setHistory] = useLocalStorage(LOCAL_STORAGE_HISTORY_KEY, []);
            const [userQuery, setUserQuery] = useState('');
            const [conversation, setConversation] = useState([]);

            const activeProfile = useMemo(() => {
                return profiles.find(p => p.id === activeProfileId) || profiles[0] || DEFAULT_PROFILE;
            }, [profiles, activeProfileId]);

            useEffect(() => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [theme]);
            
            const showToast = useCallback((message) => {
                setToastMessage(message);
                setTimeout(() => setToastMessage(null), 3000);
            }, []);

            const handleClosePanels = useCallback(() => {
                setSettingsOpen(false);
                setHistoryOpen(false);
                setTutorialOpen(false);
            }, []);

            const handleToggleSettings = useCallback((open) => {
                const nextState = open ?? !isSettingsOpen;
                setSettingsOpen(nextState);
                if (nextState) { setHistoryOpen(false); setTutorialOpen(false); }
            }, [isSettingsOpen]);

            const handleToggleHistory = useCallback((open) => {
                const nextState = open ?? !isHistoryOpen;
                setHistoryOpen(nextState);
                if (nextState) { setSettingsOpen(false); setTutorialOpen(false); }
            }, [isHistoryOpen]);
            
            const handleToggleTutorial = useCallback((open) => {
                const nextState = open ?? !isTutorialOpen;
                setTutorialOpen(nextState);
                if (nextState) { setSettingsOpen(false); setHistoryOpen(false); }
            }, [isTutorialOpen]);
            
            const handleToggleTheme = useCallback(() => {
                setTheme(prev => prev === 'light' ? 'dark' : 'light');
            }, [setTheme]);

            const addHistoryItem = useCallback((item) => {
                setHistory(prev => [{ ...item, time: Date.now() }, ...prev].slice(0, 10));
            }, [setHistory]);

            const handleNewChat = useCallback(() => {
                if (conversation.length > 0) {
                    const hasUserMessage = conversation.some(m => m.role === 'user');
                    const hasAssistantMessage = conversation.some(m => m.role === 'assistant' && !m.isError && m.sql);
                    if (hasUserMessage && hasAssistantMessage) {
                        addHistoryItem({ conversation });
                    }
                }
                setConversation([]);
                setUserQuery('');
            }, [conversation, addHistoryItem]);

            const handleLoadConversationFromHistory = useCallback((conversationToLoad) => {
                handleNewChat(); // Saves current chat (if any) and clears the view.
                setConversation(conversationToLoad);
            }, [handleNewChat, setConversation]);

            const handleSaveProfileSettings = (updatedSettings) => {
                const updatedProfiles = profiles.map(p =>
                    p.id === activeProfileId ? { ...p, settings: updatedSettings } : p
                );
                setProfiles(updatedProfiles);
                showToast('配置已保存！');
                handleClosePanels();
            };
            
            const handleSwitchProfile = (id) => {
                setActiveProfileId(id);
            };

            const handleCreateProfile = (name, settings) => {
                const newProfile = {
                    id: `profile_${Date.now()}`,
                    name,
                    settings
                };
                const newProfiles = [...profiles, newProfile];
                setProfiles(newProfiles);
                setActiveProfileId(newProfile.id);
                alert(`新配置 "${name}" 已创建并切换！`);
                return newProfile;
            };
            
            const handleDeleteProfile = (id) => {
                if (profiles.length <= 1) {
                    alert('无法删除唯一的配置。');
                    return;
                }
                if (window.confirm(`确定要删除配置 "${profiles.find(p=>p.id === id)?.name}" 吗？`)) {
                    const newProfiles = profiles.filter(p => p.id !== id);
                    setProfiles(newProfiles);
                    if (activeProfileId === id) {
                        setActiveProfileId(newProfiles[0].id);
                    }
                }
            };

            const handleRenameProfile = (id) => {
                const profile = profiles.find(p => p.id === id);
                if (!profile) return;
                const newName = window.prompt('请输入新的配置名称：', profile.name);
                if (newName && newName.trim()) {
                    const updatedProfiles = profiles.map(p =>
                        p.id === id ? { ...p, name: newName.trim() } : p
                    );
                    setProfiles(updatedProfiles);
                    alert('配置已成功重命名！');
                }
            };
            
            const handleExportProfile = () => {
                if (!activeProfile) return;
                downloadAsJson(activeProfile.settings, `${activeProfile.name.replace(/\s/g, '_')}_settings.json`);
            };

            const handleClearAllData = () => {
                if (window.confirm('确定要清除所有配置和历史记录吗？此操作无法撤销。')) {
                    setProfiles([DEFAULT_PROFILE]);
                    setActiveProfileId(DEFAULT_PROFILE.id);
                    setHistory([]);
                    setConversation([]);
                    alert('所有数据已清除！');
                }
            };

            useEffect(() => {
                if (!profiles || profiles.length === 0) {
                    setProfiles([DEFAULT_PROFILE]);
                }
                if (!profiles.find(p => p.id === activeProfileId)) {
                    setActiveProfileId(profiles[0]?.id || DEFAULT_PROFILE.id);
                }
            }, [profiles, activeProfileId, setProfiles, setActiveProfileId]);

            const isPanelOpen = isSettingsOpen || isHistoryOpen || isTutorialOpen;

            return (
                React.createElement('div', { className: 'min-h-screen relative' },
                    toastMessage && React.createElement(Toast, { message: toastMessage }),
                    React.createElement(Header, { 
                        onHistoryClick: () => handleToggleHistory(), 
                        onSettingsClick: () => handleToggleSettings(),
                        onTutorialClick: () => handleToggleTutorial(),
                        onToggleTheme: handleToggleTheme,
                        theme: theme
                    }),
                    React.createElement('main', { className: 'p-4 lg:max-w-4xl mx-auto flex flex-col gap-4 relative z-10' },
                        React.createElement(MainContent, {
                            userQuery,
                            setUserQuery,
                            conversation,
                            setConversation,
                            activeSettings: activeProfile.settings,
                            onNewChat: handleNewChat,
                            onSettingsClick: () => handleToggleSettings(true)
                        })
                    ),
                    React.createElement(SettingsPanel, {
                        isOpen: isSettingsOpen,
                        onClose: () => handleToggleSettings(false),
                        activeProfile: activeProfile,
                        profiles: profiles,
                        onSave: handleSaveProfileSettings,
                        onSwitch: handleSwitchProfile,
                        onCreate: handleCreateProfile,
                        onDelete: handleDeleteProfile,
                        onRename: handleRenameProfile,
                        onExport: handleExportProfile,
                        onClearAll: handleClearAllData,
                        onShowToast: showToast
                    }),
                    React.createElement(HistoryPanel, {
                        isOpen: isHistoryOpen,
                        onClose: () => handleToggleHistory(false),
                        history: history,
                        setHistory: setHistory,
                        onLoadConversation: handleLoadConversationFromHistory
                    }),
                    React.createElement(TutorialPanel, {
                        isOpen: isTutorialOpen,
                        onClose: () => handleToggleTutorial(false)
                    }),
                    isPanelOpen && React.createElement('div', {
                        onClick: handleClosePanels,
                        className: 'fixed inset-0 bg-black/40 z-40 transition-opacity duration-300',
                        'aria-hidden': 'true'
                    })
                )
            );
        };
        
        // --- From index.tsx (App Entry Point) ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
            throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
            React.createElement(React.StrictMode, null, 
                React.createElement(App, null)
            )
        );
    </script>
</body>
</html>
